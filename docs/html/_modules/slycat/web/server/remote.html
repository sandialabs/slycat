

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slycat.web.server.remote &mdash; Slycat 3.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Slycat
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../manual/user-manual.html">Slycat User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../coding-guidelines.html">Coding Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../colophon.html">Colophon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python-api.html">Python API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Slycat</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../server.html">slycat.web.server</a> &raquo;</li>
        
      <li>slycat.web.server.remote</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for slycat.web.server.remote</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2013, 2018 National Technology and Engineering Solutions of Sandia, LLC . Under the terms of Contract</span>
<span class="c1"># DE-NA0003525 with National Technology and Engineering Solutions of Sandia, LLC, the U.S. Government</span>
<span class="c1"># retains certain rights in this software.</span>

<span class="sd">&quot;&quot;&quot;Functions for managing cached remote ssh sessions.</span>

<span class="sd">Slycat makes extensive use of ssh and the `Slycat Agent` to access remote</span>
<span class="sd">resources located on the high performance computing platforms used to generate</span>
<span class="sd">ensembles.  This module provides functionality to create cached remote ssh /</span>
<span class="sd">agent sessions that can be used to retrieve data from remote hosts.  This</span>
<span class="sd">functionality is used in a variety of ways:</span>

<span class="sd">* Web clients can browse the filesystem of a remote host.</span>
<span class="sd">* Web clients can create a Slycat model using data stored on a remote host.</span>
<span class="sd">* Web clients can retrieve images on a remote host (an essential part of the parameter-image-model).</span>
<span class="sd">* Web clients can retrieve video compressed from still images on a remote host.</span>

<span class="sd">When a remote session is created, a connection to the remote host over ssh is</span>
<span class="sd">created, an agent is started (only if the required configuration is present),</span>
<span class="sd">and a unique session identifier is returned.  Callers use the session id to</span>
<span class="sd">retrieve the cached session and communicate with the remote host / agent.  A</span>
<span class="sd">&quot;last access&quot; time for each session is maintained and updated whenever the</span>
<span class="sd">cached session is accessed.  If a session times-out (a threshold amount of time</span>
<span class="sd">has elapsed since the last access) it is automatically deleted, and subsequent</span>
<span class="sd">use of the expired session id will fail.</span>

<span class="sd">Each session is bound to the IP address of the client that created it - only</span>
<span class="sd">the same client IP address is allowed to access the session.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">cherrypy</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">import</span> <span class="nn">slycat.mime_type</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.authentication</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.database</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.streaming</span>
<span class="kn">import</span> <span class="nn">slycat.web.server</span>

            
<div class="viewcode-block" id="cache_object"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.cache_object">[docs]</a><span class="k">def</span> <span class="nf">cache_object</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;cache_object </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">content_type</span><span class="p">))</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">lookup</span> <span class="o">=</span> <span class="n">pid</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">key</span>
    <span class="k">for</span> <span class="n">cache_object</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-key-cache-objects&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">lookup</span><span class="p">):</span>
        <span class="n">database</span><span class="o">.</span><span class="n">put_attachment</span><span class="p">(</span><span class="n">cache_object</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">cache_object</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;cache-object&quot;</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
        <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">cache_object</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">put_attachment</span><span class="p">(</span><span class="n">cache_object</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span></div>


<span class="n">session_cache</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">session_cache_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>


<div class="viewcode-block" id="Session"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session">[docs]</a><span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encapsulates an open session connected to a remote host.</span>

<span class="sd">  Examples</span>
<span class="sd">  --------</span>

<span class="sd">  Calling threads must serialize access to the Session object.  To facilitate this,</span>
<span class="sd">  a Session is a context manager - callers should always use a `with statement` when</span>
<span class="sd">  accessing a session:</span>

<span class="sd">  &gt;&gt;&gt; with slycat.web.server.remote.get_session(sid) as session:</span>
<span class="sd">  ...   print session.username</span>

<span class="sd">  &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">sftp</span><span class="p">,</span> <span class="n">agent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sid</span> <span class="o">=</span> <span class="n">sid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hostname</span> <span class="o">=</span> <span class="n">hostname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssh</span> <span class="o">=</span> <span class="n">ssh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sftp</span> <span class="o">=</span> <span class="n">sftp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">agent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_created</span> <span class="o">=</span> <span class="n">now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="n">now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the IP address of the client that created the session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the username used to create the session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_username</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hostname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the remote hostname accessed by the session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hostname</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sftp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sftp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">accessed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the time the session was last accessed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accessed</span>

<div class="viewcode-block" id="Session.close"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Instructing remote agent for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2"> to shutdown.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;exit&quot;</span><span class="p">}</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Session.submit_batch"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.submit_batch">[docs]</a>    <span class="k">def</span> <span class="nf">submit_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a command to the slycat-agent to start an input batch file on a cluster running SLURM.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">          Name of the batch file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">          A dictionary with the following keys: filename, jid, errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;submit-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">}</span>

            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py submit_batch&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

            <span class="c1"># parses out the job ID</span>
            <span class="n">jid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span> <span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py submit_batch&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.checkjob"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.checkjob">[docs]</a>    <span class="k">def</span> <span class="nf">checkjob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a command to the slycat-agent to check the status of a submitted job to a cluster running SLURM.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        jid : int</span>
<span class="sd">          Job ID</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">          A dictionary with the following keys: jid, status, errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;calling checkjob in remote&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;checkjob&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">jid</span><span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">delete_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sid</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Socket is closed&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py checkjob&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="c1"># parses the useful information from job status</span>
            <span class="c1">#cherrypy.log.error(&quot;response state:%s&quot; % response[&quot;output&quot;])</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;jid&quot;</span><span class="p">],</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">],</span> <span class="s2">&quot;logFile&quot;</span><span class="p">:</span><span class="n">response</span><span class="p">[</span><span class="s2">&quot;logFile&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py checkjob&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.cancel_job"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.cancel_job">[docs]</a>    <span class="k">def</span> <span class="nf">cancel_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a command to the slycat-agent to cancel a running job on a cluster running SLURM.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        jid : int</span>
<span class="sd">          Job ID</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">          A dictionary with the following keys: jid, output, errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;cancel-job&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">jid</span><span class="p">}</span>

            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py cancel_job&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;jid&quot;</span><span class="p">],</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py cancel_job&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.get_job_output"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.get_job_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_job_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a command to the slycat-agent to fetch the content of the a job&#39;s output file from a cluster running SLURM.</span>

<span class="sd">        Note that the expected format for the output file is slurm-[jid].out.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        jid : int</span>
<span class="sd">          Job ID</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">          A dictionary with the following keys: jid, output, errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;get-job-output&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">jid</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">}}</span>

            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_job_output&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;jid&quot;</span><span class="p">],</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_job_output&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.get_user_config"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.get_user_config">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a command to the slycat-agent to fetch the content of a user&#39;s .slycatrc file in their home directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">          A dictionary with the configuration values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;get-user-config&quot;</span><span class="p">}</span>

            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_user_config&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_user_config&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.set_user_config"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.set_user_config">[docs]</a>    <span class="k">def</span> <span class="nf">set_user_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a command to the slycat-agent to set the content of a user&#39;s .slycatrc file in their home directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;set-user-config&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">}}</span>

            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py set_user_config&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py set_user_config&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span></div>


<div class="viewcode-block" id="Session.run_remote_command"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.run_remote_command">[docs]</a>    <span class="k">def</span> <span class="nf">run_remote_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run a remote command from an HPC source running a slycat</span>
<span class="sd">        agent. the command could be things such as starting an hpc</span>
<span class="sd">        script or batch job or something as simple as moving files.</span>
<span class="sd">        the only requirement is that the script is in our list of </span>
<span class="sd">        trusted scripts.</span>
<span class="sd">        this_func()-&gt;calls agent_command_func()-&gt;which runs_shell_command()</span>
<span class="sd">        -&gt; which launches_script()-&gt; sends_response_to_agent()-&gt;sends_response_to_server()</span>
<span class="sd">        -&gt;sends_status_response_to_client()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        command: json</span>
<span class="sd">        form of a command to be run</span>
<span class="sd">        {</span>
<span class="sd">        &quot;scripts&quot;: //pre defined scripts that are registerd with the server</span>
<span class="sd">        [{</span>
<span class="sd">        &quot;script_name&quot;:&quot;script_name&quot;, // key for the script lookup </span>
<span class="sd">        &quot;parameters&quot;: [{key:value},...] // params that are fed to the script</span>
<span class="sd">        },...]</span>
<span class="sd">        &quot;hpc&quot;: // these are the hpc commands that may be add for thing such as slurm</span>
<span class="sd">        {</span>
<span class="sd">        &quot;is_hpc_job&quot;:bol, // determins if this should be run as an hpc job</span>
<span class="sd">        &quot;parameters&quot;:[{key:value},...] // things such as number of nodes</span>
<span class="sd">        }</span>
<span class="sd">        }</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        obj:</span>
<span class="sd">        {&quot;msg&quot;:&quot;message from the agent&quot;, &quot;error&quot;: boolean}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check for an agent if none available die</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py run_agent_function&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;no Slycat agent present on remote host.&quot;</span><span class="p">)</span>

        <span class="c1"># get the name of our slycat module on the hpc</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">[</span><span class="s2">&quot;hpc&quot;</span><span class="p">][</span><span class="s2">&quot;is_hpc_job&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">command</span><span class="p">[</span><span class="s2">&quot;hpc&quot;</span><span class="p">]:</span>
            <span class="n">command</span><span class="p">[</span><span class="s2">&quot;hpc&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;module_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;module-name&quot;</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">]:</span>
                <span class="n">command</span><span class="p">[</span><span class="s2">&quot;hpc&quot;</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="s2">&quot;module_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;module-name&quot;</span><span class="p">]</span>
        <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;run-remote-command&quot;</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span>
        <span class="p">}</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;writing msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">raw_response</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;reading msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">raw_response</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">raw_response</span><span class="p">)</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;response msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;agent response was not OK msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py run_agent_function&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                                     <span class="n">message</span><span class="o">=</span><span class="s2">&quot;run_agent_function response was not ok: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">],</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">],</span>
            <span class="s2">&quot;available_scripts&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;available_scripts&quot;</span><span class="p">],</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">],</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span>
            <span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;jid&quot;</span><span class="p">],</span>
            <span class="s2">&quot;log_file_path&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;log_file_path&quot;</span><span class="p">]</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Session.get_remote_job_status"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.get_remote_job_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_remote_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check of the status of a job running on an agent with a hostanemd session</span>
<span class="sd">        :param jid: job id</span>
<span class="sd">        :return: </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jid&quot;</span><span class="p">:</span> <span class="n">jid</span><span class="p">}</span>
        <span class="c1"># check for an agent if none available die</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No Slycat agent present on remote host.&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py run_agent_function&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 no Slycat agent present on remote host.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s2">&quot;no Slycat agent present on remote host.&quot;</span><span class="p">)</span>

        <span class="c1"># get the name of our slycat module on the hpc</span>
        <span class="n">command</span><span class="p">[</span><span class="s2">&quot;module-name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;module-name&quot;</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">]:</span>
            <span class="n">command</span><span class="p">[</span><span class="s2">&quot;module-name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;module-name&quot;</span><span class="p">]</span>
        <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;check-agent-job&quot;</span><span class="p">,</span>
            <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span>
        <span class="p">}</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;writing msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;response msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;agent response was not OK msg: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py run_agent_function&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                                     <span class="n">message</span><span class="o">=</span><span class="s2">&quot;run_agent_function response was not ok: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="Session.launch"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.launch">[docs]</a>    <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits a single command to a remote location via the slycat-agent or SSH.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        command : string</span>
<span class="sd">          Command</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        response : dict</span>
<span class="sd">          A dictionary with the following keys: command, output, errors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;launch&quot;</span><span class="p">,</span> <span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">}</span>

            <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
            <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py launch&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">],</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]}</span>

        <span class="c1"># launch via ssh...</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;command&quot;</span><span class="p">:</span> <span class="n">command</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">())}</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py launch&quot;</span><span class="p">,</span> <span class="s2">&quot;cherrypy.HTTPError 500 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py launch&quot;</span><span class="p">,</span> <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.browse"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.browse">[docs]</a>    <span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_reject</span><span class="p">,</span> <span class="n">file_allow</span><span class="p">,</span> <span class="n">directory_reject</span><span class="p">,</span> <span class="n">directory_allow</span><span class="p">):</span>
        <span class="c1"># Use the agent to browse.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;browse&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">file_reject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">command</span><span class="p">[</span><span class="s2">&quot;file-reject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_reject</span>
            <span class="k">if</span> <span class="n">file_allow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">command</span><span class="p">[</span><span class="s2">&quot;file-allow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_allow</span>
            <span class="k">if</span> <span class="n">directory_reject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">command</span><span class="p">[</span><span class="s2">&quot;directory-reject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directory_reject</span>
            <span class="k">if</span> <span class="n">directory_allow</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">command</span><span class="p">[</span><span class="s2">&quot;directory-allow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directory_allow</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">delete_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sid</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Socket is closed&#39;</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="c1">#cherrypy.log.error(&quot;response&quot;)</span>
                <span class="c1">#cherrypy.log.error(str(response))</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
            <span class="c1">#cherrypy.log.error(&quot;response&quot;)</span>
            <span class="c1">#cherrypy.log.error(str(response))</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">],</span> <span class="s2">&quot;sizes&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;types&quot;</span><span class="p">],</span> <span class="s2">&quot;mtimes&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;mtimes&quot;</span><span class="p">],</span> <span class="s2">&quot;mime-types&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;mime-types&quot;</span><span class="p">]}</span>

        <span class="c1"># Use sftp to browse.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sizes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">types</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mtimes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mime_types</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sftp</span><span class="o">.</span><span class="n">listdir_attr</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">attribute</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">filetype</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;f&quot;</span>

                <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">directory_reject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">directory_reject</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">directory_allow</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">directory_allow</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;f&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file_reject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_reject</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">file_allow</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">file_allow</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>

                <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s2">&quot;d&quot;</span><span class="p">:</span>
                    <span class="n">mime_type</span> <span class="o">=</span> <span class="s2">&quot;application/x-directory&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mime_type</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">mime_type</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>
                <span class="n">types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filetype</span><span class="p">)</span>
                <span class="n">mtimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
                <span class="n">mime_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mime_type</span><span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="n">names</span><span class="p">,</span> <span class="s2">&quot;sizes&quot;</span><span class="p">:</span> <span class="n">sizes</span><span class="p">,</span> <span class="s2">&quot;types&quot;</span><span class="p">:</span> <span class="n">types</span><span class="p">,</span> <span class="s2">&quot;mtimes&quot;</span><span class="p">:</span> <span class="n">mtimes</span><span class="p">,</span>
                        <span class="s2">&quot;mime-types&quot;</span><span class="p">:</span> <span class="n">mime_types</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception reading remote file </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Garbage packet received&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 500 remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Remote access failed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;No such file&quot;</span><span class="p">:</span>
                <span class="c1"># Ideally this would be a 404, but we already use</span>
                <span class="c1"># 404 to handle an unknown sessions, and clients need to make the distinction.</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 the remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 File not found.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Permission denied&quot;</span><span class="p">:</span>
                <span class="c1"># The file exists, but is not available due to access controls</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;You do not have permission to retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span>
                    <span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your user has access &quot;</span> \
                                       <span class="s2">&quot;to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions on all &quot;</span> \
                                       <span class="s2">&quot;the parent directories!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 you do not have permission to &quot;</span>
                                        <span class="s2">&quot;retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">. Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your &quot;</span>
                                        <span class="s2">&quot;user has access to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions&quot;</span>
                                        <span class="s2">&quot; on all the parent directories.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Access denied.&quot;</span><span class="p">)</span>

            <span class="c1"># Catchall</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Remote access failed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.write_file"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.write_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Todo: fill this section out</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Sanity-check arguments.</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 unknown cache type: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cache</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown cache type: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 must specify project ID.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must specify project id.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 must specify cache key.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must specify cache key.&quot;</span><span class="p">)</span>

        <span class="c1"># Use the agent to write a file.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Writing to the agent&quot;</span><span class="p">)</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;write-file&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">encodestring</span><span class="p">(</span><span class="n">data</span><span class="p">)}))</span>
                <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">delete_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sid</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Socket is closed&#39;</span><span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;reading </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metadata</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Path must be absolute.&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is not absolute.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is not absolute.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Path not absolute.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;No read permission.&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;You do not have permission to retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span>
                    <span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your user has&quot;</span> \
                                       <span class="s2">&quot; access to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions&quot;</span> \
                                       <span class="s2">&quot; on all the parent directories!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 you do not have permission to &quot;</span>
                                        <span class="s2">&quot;retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">. Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that&quot;</span>
                                        <span class="s2">&quot; your user has access to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate &quot;</span>
                                        <span class="s2">&quot;permissions on all the parent directories.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Access denied.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Path not found.&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 the remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 File not found.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Directory unreadable.&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is a directory.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 can&#39;t read directory </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Can&#39;t read directory.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;You do not have permission to retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span>
                    <span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your user has access&quot;</span> \
                                       <span class="s2">&quot; to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions on all&quot;</span> \
                                       <span class="s2">&quot; the parent directories!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 you do not have permission to&quot;</span>
                                        <span class="s2">&quot; retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">. Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify &quot;</span>
                                        <span class="s2">&quot;that your user has access to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set&quot;</span>
                                        <span class="s2">&quot; appropriate permissions on all the parent directories.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Access denied.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span>
        <span class="k">return</span> <span class="s2">&quot;failed to write&quot;</span></div>

<div class="viewcode-block" id="Session.get_file"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.get_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Sanity-check arguments.</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 unknown cache type: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cache</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown cache type: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 must specify project ID.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must specify project id.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 must specify cache key.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must specify cache key.&quot;</span><span class="p">)</span>
        <span class="c1"># Use sftp to retrieve a file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sftp</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is a directory.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 can&#39;t read directory </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Can&#39;t read directory.&quot;</span><span class="p">)</span>

            <span class="n">content_type</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">mime_type</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;application/octet-stream&quot;</span>

            <span class="n">my_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sftp</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">my_file</span><span class="o">.</span><span class="n">prefetch</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">my_file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">my_file</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span>
                <span class="n">cache_object</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>
            <span class="k">return</span> <span class="n">content</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception reading remote file </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Garbage packet received&quot;</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 500 remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Remote access failed.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;No such file&quot;</span><span class="p">:</span>
                <span class="c1"># Ideally this would be a 404, but we already use</span>
                <span class="c1"># 404 to handle an unknown sessions, and clients need to make the distinction.</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 the remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 File not found.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Permission denied&quot;</span><span class="p">:</span>
                <span class="c1"># The file exists, but is not available due to access controls</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;You do not have permission to retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span>
                    <span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your user has access &quot;</span> \
                                       <span class="s2">&quot;to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions on all &quot;</span> \
                                       <span class="s2">&quot;the parent directories!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 you do not have permission to &quot;</span>
                                        <span class="s2">&quot;retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">. Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your &quot;</span>
                                        <span class="s2">&quot;user has access to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions&quot;</span>
                                        <span class="s2">&quot; on all the parent directories.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Access denied.&quot;</span><span class="p">)</span>

            <span class="c1"># Catchall</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_file&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 remote access failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Remote access failed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Session.get_image"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.get_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content-type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">max_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max-size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max-width&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">max_height</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max-height&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">cache</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Sanity-check arguments.</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;project&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 unknown cache type: </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown cache type: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 must specify project id.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must specify project id.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 must specify cache key.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must specify cache key.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No agent for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ask your system administrator to setup slycat-agent on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 no agent for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Agent required.&quot;</span><span class="p">)</span>

        <span class="c1"># Use the agent to retrieve an image.</span>
        <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;get-image&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">content_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">command</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="k">if</span> <span class="n">max_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">command</span><span class="p">[</span><span class="s2">&quot;max-size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_size</span>
        <span class="k">if</span> <span class="n">max_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">command</span><span class="p">[</span><span class="s2">&quot;max-width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_width</span>
        <span class="k">if</span> <span class="n">max_height</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">command</span><span class="p">[</span><span class="s2">&quot;max-height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_height</span>

        <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Path must be absolute.&quot;</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is not absolute.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is not absolute.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Path not absolute.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Path not found.&quot;</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 the remote file </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 File not found.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Directory unreadable.&quot;</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> is a directory.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 can&#39;t read directory for the remote path </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Can&#39;t read directory.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Access denied.&quot;</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;You do not have permission to retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span>
                <span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Check the filesystem on </span><span class="si">%s</span><span class="s2"> to verify that your user has access &quot;</span> \
                                   <span class="s2">&quot;to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate permissions on all &quot;</span> \
                                   <span class="s2">&quot;the parent directories!&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_image&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 you do not have permission to &quot;</span>
                                    <span class="s2">&quot;retrieve </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">. Check the filesystem on </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> to verify that &quot;</span>
                                    <span class="s2">&quot;your user has access to </span><span class="si">%s</span><span class="s2">, and don&#39;t forget to set appropriate &quot;</span>
                                    <span class="s2">&quot;permissions on all the parent directories.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Access denied.&quot;</span><span class="p">)</span>

        <span class="n">content_type</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">cache</span> <span class="o">==</span> <span class="s2">&quot;project&quot;</span><span class="p">:</span>
            <span class="n">cache_object</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

        <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>
        <span class="k">return</span> <span class="n">content</span></div>

<div class="viewcode-block" id="Session.get_video"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.Session.get_video">[docs]</a>    <span class="k">def</span> <span class="nf">get_video</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vsid</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;No agent for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;x-slycat-hint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ask your system administrator to setup slycat-agent on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_video&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 no agent for </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Agent required.&quot;</span><span class="p">)</span>

        <span class="c1"># Get the video from the agent.</span>
        <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>

        <span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;get-video&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">:</span> <span class="n">vsid</span><span class="p">}))</span>
        <span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="create_session"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.create_session">[docs]</a><span class="k">def</span> <span class="nf">create_session</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a cached remote session for the given host.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hostname : string</span>
<span class="sd">      Name of the remote host to connect via ssh.</span>
<span class="sd">    username : string</span>
<span class="sd">      Username for ssh authentication.</span>
<span class="sd">    password : string</span>
<span class="sd">      Password for ssh authentication.</span>
<span class="sd">    agent: bool</span>
<span class="sd">      Used to require / prevent agent startup.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sid : string</span>
<span class="sd">      A unique session identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_start_session_cleanup_worker</span><span class="p">()</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x-forwarded-for&quot;</span><span class="p">)</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ssh_connect</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
        <span class="c1"># Detect problematic startup scripts.</span>
        <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s2">&quot;/bin/true&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 500 Slycat can&#39;t connect because you &quot;</span>
                                    <span class="s2">&quot;have a startup script (~/.ssh/rc, ~/.bashrc, ~/.cshrc or similar)&quot;</span>
                                    <span class="s2">&quot; that writes data to stdout. Startup scripts should only write to &quot;</span>
                                    <span class="s2">&quot;stderr, never stdout - see sshd(8).&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
                <span class="s2">&quot;500 Slycat can&#39;t connect because you have a startup script &quot;</span>
                <span class="s2">&quot;(~/.ssh/rc, ~/.bashrc, ~/.cshrc or similar) that writes data to stdout. &quot;</span>
                <span class="s2">&quot;Startup scripts should only write to stderr, never stdout - see sshd(8).&quot;</span><span class="p">)</span>

        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Created remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">client</span><span class="p">))</span>
        <span class="c1"># Start sftp.</span>
        <span class="n">sftp</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>

        <span class="c1"># Optionally start an agent.</span>
        <span class="n">remote_hosts</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;remote-hosts&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">agent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="n">hostname</span> <span class="ow">in</span> <span class="n">remote_hosts</span> <span class="ow">and</span> <span class="s2">&quot;agent&quot;</span> <span class="ow">in</span> <span class="n">remote_hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">agent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hostname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remote_hosts</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 host </span><span class="si">%s</span><span class="s2"> not in allowed remote hosts.&quot;</span> <span class="o">%</span> <span class="n">hostname</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Missing agent configuration.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;agent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remote_hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 missing agent configuration for host </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">hostname</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Missing agent configuration.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;command&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remote_hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 500 missing agent configuration&quot;</span>
                                        <span class="s2">&quot; for host </span><span class="si">%s</span><span class="s2">: missing command keyword.&quot;</span> <span class="o">%</span> <span class="n">hostname</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Missing agent configuration.&quot;</span><span class="p">)</span>

            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Starting agent executable for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> with command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">remote_hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">][</span><span class="s2">&quot;command&quot;</span><span class="p">]))</span>
            <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="n">remote_hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">][</span><span class="s2">&quot;command&quot;</span><span class="p">])</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Started agent&quot;</span><span class="p">)</span>
            <span class="c1"># Handle catastrophic startup failures (the agent process failed to start).</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">startup</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;500 agent startup failed for host </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 500 agent startup failed for host </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">hostname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Agent startup failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="c1"># Handle clean startup failures (the agent process started, but reported an error).</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">startup</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;500 agent startup failed for host </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">startup</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]))</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 500 agent startup failed for host </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">hostname</span><span class="p">,</span> <span class="n">startup</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Agent startup failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">startup</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">])</span>
            <span class="n">agent</span> <span class="o">=</span> <span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
                <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">sftp</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
                <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ssh</span><span class="p">,</span> <span class="n">sftp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sid</span>
    <span class="k">except</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Agent startup failed for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Agent startup failed for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">AuthenticationException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Authentication failed for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 403 authentication failed for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;403 Remote authentication failed.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unknown exception for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py create_session&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 500 unknown exception for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">username</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;401 Remote connection failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_session"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.get_session">[docs]</a><span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">calling_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a cached remote session.</span>

<span class="sd">    If the session has timed-out or doesn&#39;t exist, raises a 404 exception.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sid : string</span>
<span class="sd">      Unique session identifier returned by :func:`slycat.web.server.remote.create_session`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    session : :class:`slycat.web.server.remote.Session`</span>
<span class="sd">      Session object that encapsulates the connection to a remote host.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calling_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x-forwarded-for&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client</span><span class="o">=</span><span class="n">calling_client</span>
    <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
        <span class="n">_expire_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="c1">#Only the originating client can access a session.</span>
            <span class="k">if</span> <span class="n">client</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Client </span><span class="si">%s</span><span class="s2"> attempted to access remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">client</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 404: client </span><span class="si">%s</span><span class="s2"> attempted to &quot;</span>
                                        <span class="s2">&quot;access remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">client</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 not a session&quot;</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">session</span></div>


<div class="viewcode-block" id="get_session_server"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.get_session_server">[docs]</a><span class="k">def</span> <span class="nf">get_session_server</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a cached remote session.</span>

<span class="sd">    If the session has timed-out or doesn&#39;t exist, raises a 404 exception.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sid : string</span>
<span class="sd">      Unique session identifier returned by :func:`slycat.web.server.remote.create_session`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    session : :class:`slycat.web.server.remote.Session`</span>
<span class="sd">      Session object that encapsulates the connection to a remote host.</span>
<span class="sd">      :param client:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
        <span class="n">_expire_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="c1"># Only the originating client can access a session.</span>
            <span class="k">if</span> <span class="n">client</span> <span class="o">!=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Client </span><span class="si">%s</span><span class="s2"> attempted to access remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">client</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.remote.py get_session&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 404: client </span><span class="si">%s</span><span class="s2"> attempted to &quot;</span>
                                        <span class="s2">&quot;access remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">client</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 not a session&quot;</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="n">session</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">session</span></div>


<div class="viewcode-block" id="check_session"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.check_session">[docs]</a><span class="k">def</span> <span class="nf">check_session</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a true if session is active</span>

<span class="sd">    If the session has timed-out or doesn&#39;t exist, returns false</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sid : string</span>
<span class="sd">      Unique session identifier returned by :func:`slycat.web.server.remote.create_session`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean :</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># client = cherrypy.request.headers.get(&quot;x-forwarded-for&quot;)</span>

    <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
        <span class="n">_expire_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="c1"># Only the originating client can access a session.</span>
            <span class="c1"># if client != session.client:</span>
            <span class="c1">#     response = False</span>

        <span class="k">if</span> <span class="n">sid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="n">session</span><span class="o">.</span><span class="n">_accessed</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="delete_session"><a class="viewcode-back" href="../../../../slycat.web.server.remote.html#slycat.web.server.remote.delete_session">[docs]</a><span class="k">def</span> <span class="nf">delete_session</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a cached remote session.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sid : string, required</span>
<span class="sd">      Unique session identifier returned by :func:`slycat.web.server.remote.create_session`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Deleting remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
            <span class="c1"># try to close the session before we delete it</span>
            <span class="k">try</span><span class="p">:</span>
              <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="k">pass</span>
            <span class="k">del</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_expire_session</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test an existing session to see if it is expired.</span>

<span class="sd">    Assumes that the caller already holds session_cache_lock.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">session_cache</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">session</span><span class="o">.</span><span class="n">accessed</span> <span class="o">&gt;</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;remote-session-timeout&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Timing-out remote session for </span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>    
              <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
              <span class="k">pass</span>
            <span class="k">del</span> <span class="n">session_cache</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_session_monitor</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1">#cherrypy.log.error(&quot;Remote session cleanup worker running.&quot;)</span>
        <span class="k">with</span> <span class="n">session_cache_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">session_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>  <span class="c1"># We make an explicit copy of the keys because we may be modifying the dict contents</span>
                <span class="n">_expire_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Remote session cleanup worker finished.&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_start_session_cleanup_worker</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">_start_session_cleanup_worker</span><span class="o">.</span><span class="n">thread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Starting remote session cleanup worker.&quot;</span><span class="p">)</span>
        <span class="n">_start_session_cleanup_worker</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;SSH Monitor&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">_session_monitor</span><span class="p">)</span>
        <span class="n">_start_session_cleanup_worker</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_start_session_cleanup_worker</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="n">_start_session_cleanup_worker</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>