

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>slycat.web.server.handlers &mdash; Slycat 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Slycat
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../manual/user-manual.html">Slycat User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../design.html">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../coding-guidelines.html">Coding Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../colophon.html">Colophon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rest-api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python-api.html">Python API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Slycat</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../server.html">slycat.web.server</a> &raquo;</li>
        
      <li>slycat.web.server.handlers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for slycat.web.server.handlers</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- </span>
<span class="c1"># Copyright (c) 2013, 2018 National Technology and Engineering Solutions of Sandia, LLC . Under the terms of Contract</span>
<span class="c1"># DE-NA0003525 with National Technology and Engineering Solutions of Sandia, LLC, the U.S. Government</span>
<span class="c1"># retains certain rights in this software.</span>

<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">cherrypy</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">_pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">slycat.hdf5</span>
<span class="kn">import</span> <span class="nn">slycat.hyperchunks</span>
<span class="kn">import</span> <span class="nn">slycat.uri</span>
<span class="kn">import</span> <span class="nn">slycat.web.server</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.authentication</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.cleanup</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.database.couchdb</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.hdf5</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.plugin</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.remote</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.streaming</span>
<span class="kn">import</span> <span class="nn">slycat.web.server.upload</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">parse_qs</span>
<div class="viewcode-block" id="MyEncoder"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.MyEncoder">[docs]</a><span class="k">class</span> <span class="nc">MyEncoder</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
<div class="viewcode-block" id="MyEncoder.default"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.MyEncoder.default">[docs]</a>    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="get_sid"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_sid">[docs]</a><span class="k">def</span> <span class="nf">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a hostname address and returns the established sid value</span>
<span class="sd">    base on what is found in the users session</span>
<span class="sd">    raises 400 and 404</span>
<span class="sd">    :param hostname: name of the host we are trying to connect to</span>
<span class="sd">    :return: sid : uuid for the session name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">host_session</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">host_session</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hostname</span><span class="p">:</span>
                <span class="n">sid</span> <span class="o">=</span> <span class="n">host_session</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span>
                <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">check_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)):</span>
                    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;error </span><span class="si">%s</span><span class="s2"> SID:</span><span class="si">%s</span><span class="s2"> Keys </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">check_session</span><span class="p">(</span><span class="n">sid</span><span class="p">),</span> <span class="n">sid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">session_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404&quot;</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;could not retrieve host session for remotes </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 session is None value&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sid</span></div>


<div class="viewcode-block" id="require_json_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.require_json_parameter">[docs]</a><span class="k">def</span> <span class="nf">require_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      checks to see if the parameter is in the cherrypy.request.json</span>
<span class="sd">      and errors gracefully if it is not there</span>
<span class="sd">      :param name: name of json param</span>
<span class="sd">      :return: value of the json param</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py require_json_parameter&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 missing &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Missing &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="require_boolean_json_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.require_boolean_json_parameter">[docs]</a><span class="k">def</span> <span class="nf">require_boolean_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py require_boolean_json_parameter&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be true or false.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be true or false.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="require_array_json_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.require_array_json_parameter">[docs]</a><span class="k">def</span> <span class="nf">require_array_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py require_array_json_parameter&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be an array.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be an array.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span></div>


<div class="viewcode-block" id="require_integer_array_json_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.require_integer_array_json_parameter">[docs]</a><span class="k">def</span> <span class="nf">require_integer_array_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">require_array_json_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">array</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py require_integer_array_json_parameter&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be an array of integers.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be an array of integers.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">array</span></div>


<div class="viewcode-block" id="require_integer_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.require_integer_parameter">[docs]</a><span class="k">def</span> <span class="nf">require_integer_parameter</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py require_integer_parameter&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be an integer.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 &#39;</span><span class="si">%s</span><span class="s2">&#39; parameter must be an integer.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_last_active_time"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_last_active_time">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_last_active_time</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks when the most recent session activity occured.</span>
<span class="sd">    If it occured more than 10 minutes ago, returns true.</span>
<span class="sd">    If less than 10 minutes ago, returns false.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">most_recent_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>
    <span class="n">time_threshold</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s2">&quot;slycat/sessions&quot;</span><span class="p">,</span> <span class="n">include_docs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;creator&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat&quot;</span><span class="p">][</span><span class="s2">&quot;server-admins&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;last-active-time&quot;</span><span class="p">]),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">most_recent_time</span><span class="p">:</span>
            <span class="n">most_recent_time</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;last-active-time&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">most_recent_time</span><span class="p">),</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">time_threshold</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="get_projects_list"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_projects_list">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_projects_list</span><span class="p">(</span><span class="n">_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns an array of projects</span>
<span class="sd">    :param _: time arg to stop caching</span>
<span class="sd">    :return: json projects list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="p">[</span><span class="n">project</span> <span class="k">for</span> <span class="n">project</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/projects&quot;</span><span class="p">)</span> <span class="k">if</span>
                <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">is_project_reader</span><span class="p">(</span>
                    <span class="n">project</span><span class="p">)</span> <span class="ow">or</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">is_project_writer</span><span class="p">(</span>
                    <span class="n">project</span><span class="p">)</span> <span class="ow">or</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">is_project_administrator</span><span class="p">(</span>
                    <span class="n">project</span><span class="p">)</span> <span class="ow">or</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">is_server_administrator</span><span class="p">()]</span>
    <span class="n">projects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">projects</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;revision&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;projects&quot;</span><span class="p">:</span> <span class="n">projects</span><span class="p">}</span></div>


<div class="viewcode-block" id="post_projects"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_projects">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_projects</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    creates a new project</span>
<span class="sd">    Raises:</span>
<span class="sd">      cherrypy.HTTPError -- if the project name is missing from the post json raises 400</span>
<span class="sd">    Returns:</span>
<span class="sd">      [json] -- project id that was created</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Missing project name.&quot;</span><span class="p">)</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">pid</span><span class="p">,</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">({</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;project&quot;</span><span class="p">,</span>
        <span class="s2">&quot;acl&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;administrators&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">}],</span> <span class="s2">&quot;readers&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;writers&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="p">})</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/projects/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;201 Project created.&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">}</span></div>

<div class="viewcode-block" id="get_project"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_project</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns a project based on &quot;content-type&quot; header</span>
<span class="sd">    :param pid: project ID</span>
<span class="sd">    :return: Either html landing page of given project or the json</span>
<span class="sd">    representation of the project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">is_server_administrator</span><span class="p">():</span>
        <span class="n">project</span><span class="p">[</span><span class="s1">&#39;acl&#39;</span><span class="p">][</span><span class="s2">&quot;server_administrators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">project</span><span class="p">[</span><span class="s1">&#39;acl&#39;</span><span class="p">][</span><span class="s2">&quot;server_administrators&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;user&#39;</span><span class="p">:</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">project</span></div>

<div class="viewcode-block" id="get_remote_host_dict"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remote_host_dict">[docs]</a><span class="k">def</span> <span class="nf">get_remote_host_dict</span><span class="p">():</span>
    <span class="n">remote_host_dict</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;remote-hosts&quot;</span><span class="p">]</span>
    <span class="n">remote_host_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">remote_host_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">remote_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">]:</span>
            <span class="n">remote_host_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">remote_host_dict</span><span class="p">[</span><span class="n">host</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remote_host_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">host</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">remote_host_list</span></div>


<div class="viewcode-block" id="put_project"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_project">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_project</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes json in the format of </span>
<span class="sd">    acl:</span>

<span class="sd">    administrators: list of object </span>
<span class="sd">    user:username</span>

<span class="sd">    writers: list of object</span>
<span class="sd">    user:username</span>

<span class="sd">    readers: list of object</span>
<span class="sd">    user:username</span>

<span class="sd">    name: string</span>
<span class="sd">    name of the project</span>

<span class="sd">    description: string</span>
<span class="sd">    description of the project, </span>
<span class="sd">    and updates the project json from this object.</span>
<span class="sd">    all top order fields are optional</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">      pid: string</span>
<span class="sd">           uui for project</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">      cherrypy.HTTPError</span>
<span class="sd">        400 missing administrators</span>
<span class="sd">      cherrypy.HTTPError</span>
<span class="sd">        400 missing writers</span>
<span class="sd">      cherrypy.HTTPError</span>
<span class="sd">        400 missing readers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">mutations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;acl&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_administrator</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;server_administrators&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">][</span><span class="s2">&quot;server_administrators&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;administrators&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_project&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 missing administrators.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 missing administrators&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;writers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_project&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 missing writers.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 missing writers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;readers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_project&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 missing readers.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 missing readers&quot;</span><span class="p">)</span>
        <span class="n">project</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;acl&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">project</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
        <span class="n">project</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>

    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;200 Project updated.&quot;</span></div>


<div class="viewcode-block" id="delete_project"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_project">[docs]</a><span class="k">def</span> <span class="nf">delete_project</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes a project and all its models.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        pid {string} -- project id</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_administrator</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cache_object</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-cache-objects&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_object</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">reference</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-references&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">bookmark</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-bookmarks&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">bookmark</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-models&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">project_data</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project_datas&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">project_data</span><span class="p">)</span>

    <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">cleanup</span><span class="o">.</span><span class="n">arrays</span><span class="p">()</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Project deleted.&quot;</span></div>


<div class="viewcode-block" id="get_project_models"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_models">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_project_models</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of project models.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        pid {string} -- project id</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json -- list of models in project</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-models&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">)]</span>
    <span class="n">models</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">models</span></div>

<div class="viewcode-block" id="put_project_csv_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_project_csv_data">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_project_csv_data</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">file_key</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">aids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns a project based on &quot;content-type&quot; header</span>
<span class="sd">    :param pid: project ID</span>
<span class="sd">    :param file_key: file_name</span>
<span class="sd">    :param parser: parser name</span>
<span class="sd">    :param mid: model ID</span>
<span class="sd">    :param aids: artifact IDs</span>
<span class="sd">    :return: status 404 if no file found or with json {&quot;Status&quot;: &quot;Success&quot;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">project_datas</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project_datas&quot;</span><span class="p">)]</span>
    <span class="n">attachment</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># check for existing project_datas data types</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">project_datas</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[MICROSERVICE] The project_datas list is empty.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 There is no project data stored for this project. </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">file_key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">project_datas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span> <span class="ow">and</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">file_key</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
                <span class="n">http_response</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_attachment</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span>
                <span class="n">file</span> <span class="o">=</span> <span class="n">http_response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># Must convert from bytes to string</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">attachment</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># if we didnt fined the file repspond with not found</span>
    <span class="k">if</span> <span class="n">fid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 There was no file with name </span><span class="si">%s</span><span class="s2"> found.&quot;</span> <span class="o">%</span> <span class="n">file_key</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span>
        <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mid</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">project_data</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="c1"># clean up the attachment by removing white space</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attachment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">attachment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">attachment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">attachment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;project_data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">parse_existing_file</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">attachment</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aids</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Status&quot;</span><span class="p">:</span> <span class="s2">&quot;Success&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="get_project_file_names"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_file_names">[docs]</a><span class="k">def</span> <span class="nf">get_project_file_names</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">project_datas</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project_datas&quot;</span><span class="p">)]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">project_datas</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The project_datas list is empty.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#cherrypy.log.error(&quot;Files found.&quot;)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">project_datas</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
                <span class="c1"># data_id = item[&quot;_id&quot;]</span>
                <span class="n">temp_json_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]}</span>
                <span class="c1">#cherrypy.log.error(&quot;The file name is: &quot;)</span>
                <span class="c1">#cherrypy.log.error(str(temp_json_data))</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_json_data</span><span class="p">)</span>

    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_data</span></div>

<div class="viewcode-block" id="get_project_references"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_references">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_project_references</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">references</span> <span class="o">=</span> <span class="p">[</span><span class="n">reference</span> <span class="k">for</span> <span class="n">reference</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-references&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">)]</span>
    <span class="n">references</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">references</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">references</span></div>


<div class="viewcode-block" id="post_project_models"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_project_models">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_project_models</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When a pid along with json &quot;model-type&quot;, &quot;marking&quot;, &quot;name&quot; is sent with POST</span>
<span class="sd">    creates a model and saves it to the database</span>
<span class="sd">    :param pid: project ID for created model</span>
<span class="sd">    :return: json {&quot;id&quot; : mid}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="c1"># create the model</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;model-type&quot;</span><span class="p">)</span>
    <span class="n">allowed_model_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_model_types</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_project_models&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError allowed model types: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_model_types</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Allowed model types: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_model_types</span><span class="p">))</span>

    <span class="n">marking</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;marking&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marking</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;allowed-markings&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_project_models&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 allowed marking types: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                    <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;allowed-markings&quot;</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Allowed marking types: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;allowed-markings&quot;</span><span class="p">]))</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

    <span class="n">model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
        <span class="s2">&quot;bookmark&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model-type&quot;</span><span class="p">:</span> <span class="n">model_type</span><span class="p">,</span>
        <span class="s2">&quot;marking&quot;</span><span class="p">:</span> <span class="n">marking</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="s2">&quot;artifact-types&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;input-artifacts&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;waiting&quot;</span><span class="p">,</span>
        <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;started&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;finished&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/models/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;201 Model created.&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">mid</span><span class="p">}</span></div>

<span class="c1"># @cherrypy.tools.json_in(on=True)</span>
<span class="c1"># @cherrypy.tools.json_out(on=True)</span>
<div class="viewcode-block" id="create_project_data_from_pid"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.create_project_data_from_pid">[docs]</a><span class="k">def</span> <span class="nf">create_project_data_from_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    creates a project level data object from a project id </span>
<span class="sd">    that can be used to create new</span>
<span class="sd">    models in the current project</span>
<span class="sd">    :param file_name: artifact ID</span>
<span class="sd">    :param file: file attachment</span>
<span class="sd">    :return: not used</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">csv_data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

    <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/csv&quot;</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">formatted_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
    <span class="n">did</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">did</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;project_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">formatted_timestamp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">,</span>
        <span class="s2">&quot;data_table&quot;</span><span class="p">:</span> <span class="s2">&quot;data-table&quot;</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
        <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span>
        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">put_attachment</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">csv_data</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[MICROSERVICE] Added project data </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="create_project_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.create_project_data">[docs]</a><span class="k">def</span> <span class="nf">create_project_data</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    creates a project level data object that can be used to create new</span>
<span class="sd">    models in the current project</span>
<span class="sd">    :param mid: model ID</span>
<span class="sd">    :param aid: artifact ID</span>
<span class="sd">    :param file: file attachment</span>
<span class="sd">    :return: not used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;text/csv&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_lock</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">project</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">formatted_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

        <span class="c1">#TODO review how we pass files to this</span>
        <span class="c1"># our file got passed as a list by someone...</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#TODO review how we pass aids to this</span>
        <span class="c1"># if true we are using the new file naming structure</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># looks like we got passed a list(list()) lets extract the name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">aid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aid</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># for backwards compatibility for not passing the file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;unnamed_file&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">did</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;project_data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">formatted_timestamp</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">aid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;data_table&quot;</span><span class="p">:</span> <span class="n">aid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
            <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">mid</span><span class="p">],</span>
            <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="s2">&quot;project_data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">put_attachment</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[MICROSERVICE] Added project data </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="post_log"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_log">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_log</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    send post json {&quot;message&quot;:&quot;message&quot;} to log client errors onto the</span>
<span class="sd">    client server</span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;[CLIENT/JAVASCRIPT]:: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;logged&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span></div>


<div class="viewcode-block" id="post_project_bookmarks"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_project_bookmarks">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_project_bookmarks</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span>
        <span class="n">project</span><span class="p">)</span>  <span class="c1"># This is intentionally out-of-the-ordinary - we explicitly allow project *readers* to store bookmarks.</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bid</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">pid</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">db_lock</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">database</span><span class="p">[</span><span class="n">bid</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">bid</span><span class="p">,</span>
                <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
            <span class="p">}</span>
            <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">database</span><span class="o">.</span><span class="n">put_attachment</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;bookmark&quot;</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/bookmarks/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">bid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;201 Bookmark stored.&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">bid</span><span class="p">}</span></div>


<div class="viewcode-block" id="post_project_references"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_project_references">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_project_references</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">rid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

    <span class="n">reference</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">rid</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reference&quot;</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span>
        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;creator&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;model-type&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model-type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;bid&quot;</span><span class="p">:</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/references/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">rid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;201 Reference created.&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">rid</span><span class="p">}</span></div>


<div class="viewcode-block" id="put_reference"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_reference">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_reference</span><span class="p">(</span><span class="n">rid</span><span class="p">):</span>
    <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">,</span> <span class="n">rid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">reference</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">reference</span><span class="p">[</span><span class="s2">&quot;bid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">couchdb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;201 Reference updated.&quot;</span></div>

<div class="viewcode-block" id="get_model"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a model.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json -- represents a model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="get_project_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_data">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_project_data</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a project data.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        did {string} -- data id</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json -- represents a project data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">project_data</span></div>

<div class="viewcode-block" id="get_project_data_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_data_parameter">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_project_data_parameter</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a project data parameter.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        did {string} -- data id</span>
<span class="sd">        param {string} -- name of parameter to return</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json -- represents a project data parameter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_project_data_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">project_data</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_project_data_parameter&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 404 unknown parameter: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 Unknown parameter: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">param</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_project_data_in_model"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_data_in_model">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_project_data_in_model</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of the project data in a model.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>

<span class="sd">    Returns:</span>
<span class="sd">        json -- represents the project data in the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">did</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">did</span></div>

<div class="viewcode-block" id="delete_project_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_project_data">[docs]</a><span class="k">def</span> <span class="nf">delete_project_data</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a project data record from couchdb.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        did {string} -- project data id</span>

<span class="sd">    Returns:</span>
<span class="sd">        Nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/models&quot;</span><span class="p">):</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;project_data&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">model_did</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">model_did</span> <span class="o">==</span> <span class="n">did</span><span class="p">:</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">del</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_project_data_lock</span><span class="p">(</span><span class="n">did</span><span class="p">):</span>
        <span class="n">database</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">project_data</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Project Data deleted.&quot;</span></div>


<div class="viewcode-block" id="model_command"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.model_command">[docs]</a><span class="k">def</span> <span class="nf">model_command</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a custom model command.</span>

<span class="sd">    Plugins may register custom commands to be executed</span>
<span class="sd">    on the server, using an existing model as context.</span>
<span class="sd">    Custom commands are used to perform computation on</span>
<span class="sd">    the server instead of the client, and would typically</span>
<span class="sd">    use model artifacts as inputs.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>
<span class="sd">        type {string} -- Unique command category.</span>
<span class="sd">        command {string} -- Custom command name.</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 400 Unknown command:</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        any -- whatever the registered command</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">model_commands</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">model_commands</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span>
                                                                    <span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py model_command&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;cherrypy.HTTPError 400 unknown command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span></div>


<div class="viewcode-block" id="model_sensitive_command"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.model_sensitive_command">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">model_sensitive_command</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span>

    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">model_commands</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">model_commands</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span>
                                                                    <span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py model_sensitive_command&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;cherrypy.HTTPError 400 unknown command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown command: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">command</span><span class="p">)</span></div>


<div class="viewcode-block" id="put_model"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_model">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_model</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_lock</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
        <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

        <span class="n">save_model</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="s2">&quot;progress&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;finished&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;marking&quot;</span><span class="p">,</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 unknown model parameter: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown model parameter: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;finished&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;cherrypy.HTTPError 400 timestamp fields must use ISO-8601.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Timestamp fields must use ISO-8601.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">model</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">save_model</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Revisit this, how booksmark IDs get added to model</span>

                <span class="c1">#if key == &quot;bookmark&quot;:</span>
                <span class="c1">#    model[key].append(value)</span>
                <span class="c1">#    save_model = True</span>
                <span class="c1">#else:</span>
                <span class="c1">#    model[key] = value</span>
                <span class="c1">#    save_model = True</span>

                <span class="c1"># model[key] = value</span>
                <span class="c1"># save_model = True</span>

        <span class="k">if</span> <span class="n">save_model</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_model_finish"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_model_finish">[docs]</a><span class="k">def</span> <span class="nf">post_model_finish</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="c1"># check state of the model</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;waiting&quot;</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_finish&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 only waiting models can be finished.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Only waiting models can be finished.&quot;</span><span class="p">)</span>
    <span class="c1"># check if the model type exists</span>
    <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;model-type&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_finish&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 500 cannot finish unknown model type.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;500 Cannot finish unknown model type.&quot;</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="n">started</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                                   <span class="n">progress</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;model-type&quot;</span><span class="p">]][</span><span class="s2">&quot;finish&quot;</span><span class="p">](</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;202 Finishing model.&quot;</span></div>


<div class="viewcode-block" id="post_model_files"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_model_files">[docs]</a><span class="k">def</span> <span class="nf">post_model_files</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">input</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 required input parameter is missing.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Required input parameter is missing.&quot;</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">files</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">files</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">sids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sids</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 sids and paths parameter must have the same length.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 sids and paths parameters must have the same length.&quot;</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sid</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sids</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;cherrypy.HTTPError 400 cannot load directory </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Cannot load directory </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 must supply files parameter, or sids and path parameters.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must supply files parameter, or sids and paths parameters.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">aids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="p">[</span><span class="n">aids</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 required parser parameter is missing.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Required parser parameter is missing.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parser</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">parsers</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 unknown parser plugin: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parser</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown parser plugin: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">parser</span><span class="p">)</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">parsers</span><span class="p">[</span><span class="n">parser</span><span class="p">][</span><span class="s2">&quot;parse&quot;</span><span class="p">](</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">create_project_data</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;handles Exception parsing posted files: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_model_files&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<div class="viewcode-block" id="post_uploads"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_uploads">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_uploads</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    creates a session for uploading a file to</span>
<span class="sd">    :return: Upload ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mid</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;mid&quot;</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">require_boolean_json_parameter</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;parser&quot;</span><span class="p">)</span>
    <span class="n">aids</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;aids&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parser</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">parsers</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py post_uploads&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 unknown parser plugin: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">parser</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Unknown parser plugin: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">parser</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span>
              <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;parser&quot;</span><span class="p">,</span> <span class="s2">&quot;aids&quot;</span><span class="p">]}</span>

    <span class="n">uid</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">aids</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/uploads/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;201 Upload started.&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">uid</span><span class="p">}</span></div>


<div class="viewcode-block" id="put_upload_file_part"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_upload_file_part">[docs]</a><span class="k">def</span> <span class="nf">put_upload_file_part</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">require_integer_parameter</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="s2">&quot;fid&quot;</span><span class="p">)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">require_integer_parameter</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="s2">&quot;pid&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hostname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hostname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_upload_file_part&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 cannot load directory </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Cannot load directory </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">sftp</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_upload_file_part&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 must supply file parameter, or sid and path parameters.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Must supply file parameter, or sid and path parameters.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">put_upload_file_part</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_upload_finished"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_upload_finished">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_upload_finished</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ask the server to finish the upload</span>
<span class="sd">    :param uid: upload session ID</span>
<span class="sd">    :return: status of upload</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uploaded</span> <span class="o">=</span> <span class="n">require_integer_array_json_parameter</span><span class="p">(</span><span class="s2">&quot;uploaded&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">post_upload_finished</span><span class="p">(</span><span class="n">uploaded</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_upload"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_upload">[docs]</a><span class="k">def</span> <span class="nf">delete_upload</span><span class="p">(</span><span class="n">uid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete an upload session used to upload files for storage as model artifacts. </span>
<span class="sd">    This function must be called once the client no longer needs the session, </span>
<span class="sd">    whether the upload(s) have been completed successfully or the </span>
<span class="sd">    client is cancelling an incomplete session.</span>

<span class="sd">    status 204</span>
<span class="sd">      The upload session and any temporary storage have been deleted.</span>

<span class="sd">    status 409</span>
<span class="sd">      The upload session cannot be deleted, because parsing is in progress. </span>
<span class="sd">      Try again later.</span>

<span class="sd">    :param uid: upload sessin id</span>
<span class="sd">    :return: not used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">upload</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Upload session deleted.&quot;</span></div>


<div class="viewcode-block" id="open_id_authenticate"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.open_id_authenticate">[docs]</a><span class="k">def</span> <span class="nf">open_id_authenticate</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    takes the openid parameter sent</span>
<span class="sd">    to this function and logs in a user</span>
<span class="sd">    :param params: openid params as a dictionary</span>
<span class="sd">    :return: not used</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;++ open_id_authenticate starting, incoming params = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">)</span>
    <span class="c1"># check for openid in the config for security</span>
    <span class="k">if</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;authentication&quot;</span><span class="p">][</span><span class="s2">&quot;plugin&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;slycat-openid-authentication&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;++ open_id_authenticate incoming params = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">current_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">url</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span> <span class="o">+</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span>
    
    <span class="n">kerberos_principal</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;openid.ext2.value.Authuser&#39;</span><span class="p">]</span>
    <span class="n">auth_user</span> <span class="o">=</span> <span class="n">kerberos_principal</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;++ open_id_authenticate: setting auth_user = </span><span class="si">%s</span><span class="s2">, calling create_single_sign_on_session&quot;</span> <span class="o">%</span> <span class="n">auth_user</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">create_single_sign_on_session</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">check_https_get_remote_ip</span><span class="p">(),</span> <span class="n">auth_user</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPRedirect</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">current_url</span><span class="o">.</span><span class="n">netloc</span> <span class="o">+</span> <span class="s2">&quot;/projects&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="login"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.login">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes the post object under cherrypy.request.json with the users name and password</span>
<span class="sd">    and determins with the user can be authenticated with slycat</span>
<span class="sd">    :return: authentication status</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># try and decode the username and password</span>
    <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">decode_username_and_password</span><span class="p">()</span>

    <span class="c1"># cherrypy.log.error(&quot;login attempt started %s&quot; % datetime.datetime.utcnow())</span>
    <span class="c1"># try and delete any outdated sessions for the user if they have the cookie for it</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">clean_up_old_session</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>

    <span class="n">realm</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># get the route they came from and check if the server root is the same,</span>
    <span class="c1"># if so redirect to the place they came from</span>
    <span class="n">response_url</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">response_url</span><span class="p">()</span>

    <span class="c1"># Get the client ip, which might be forwarded by a proxy.</span>
    <span class="n">remote_ip</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;x-forwarded-for&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;x-forwarded-for&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span> <span class="k">else</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rem</span>

    <span class="c1"># see if we have a registered password checking function from our config</span>
    <span class="n">password_check</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_password_function</span><span class="p">()</span>
    <span class="c1"># time to test username and password</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">password_check</span><span class="p">(</span><span class="n">realm</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
        <span class="c1"># check the rules</span>
        <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">check_rules</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="c1"># we got passed the rules check</span>
        <span class="c1"># Successful authentication and access verification, create a session and return.</span>
        <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">create_single_sign_on_session</span><span class="p">(</span><span class="n">remote_ip</span><span class="p">,</span> <span class="n">user_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># cherrypy.log.error(&quot;user %s at %s failed authentication&quot; % (user_name, remote_ip))</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;404 no auth found!!!&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">response_url</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_root"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_root">[docs]</a><span class="k">def</span> <span class="nf">get_root</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: this function may be deprecated with the webpack move</span>
<span class="sd">    Redirect all requests to &quot;/&quot; to &quot;/projects&quot;</span>
<span class="sd">    Not sure why we used to do that, but after conversion to webpack this is no longer needed,</span>
<span class="sd">    so I changed the projects-redirect config parameter in web-server-config.ini to just &quot;/&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">url</span><span class="p">())</span>
    <span class="n">proj_url</span> <span class="o">=</span> <span class="s2">&quot;https://&quot;</span> <span class="o">+</span> <span class="n">current_url</span><span class="o">.</span><span class="n">netloc</span>
    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPRedirect</span><span class="p">(</span><span class="n">proj_url</span><span class="p">,</span> <span class="mi">303</span><span class="p">)</span></div>


<div class="viewcode-block" id="logout"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.logout">[docs]</a><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See if the client has a valid session.</span>
<span class="sd">    If so delete it</span>
<span class="sd">    :return: the status of the request</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;slycatauth&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># expire the old cookies</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sid</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">][</span><span class="s1">&#39;expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycattimeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;timeout&quot;</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycattimeout&quot;</span><span class="p">][</span><span class="s1">&#39;expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">session</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;200 session deleted.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;400 Bad Request no session to delete.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;403 Forbidden&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="clean_project_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.clean_project_data">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clean_project_data</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  cleans out project data that is not being pointed at</span>
<span class="sd">  by a parameter space model, and cleans up models that </span>
<span class="sd">  are not parameter space but point to project data</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_server_administrator</span><span class="p">()</span>
  <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
  <span class="c1"># get a view list of all pd ids</span>
  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="s2">&quot;slycat/project_datas&quot;</span><span class="p">):</span>
      <span class="n">pd_doc</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
      <span class="n">delete_pd</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="c1"># go through model list in pd and start cleaning</span>
      <span class="k">for</span> <span class="n">model_id</span> <span class="ow">in</span> <span class="n">pd_doc</span><span class="p">[</span><span class="s1">&#39;mid&#39;</span><span class="p">]:</span>
          <span class="n">model_doc</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="n">model_id</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">model_doc</span><span class="p">[</span><span class="s2">&quot;model-type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;parameter-image&quot;</span><span class="p">:</span>
              <span class="n">delete_pd</span> <span class="o">=</span> <span class="kc">False</span>
          <span class="c1"># clean up models that don&#39;t need pd</span>
          <span class="k">elif</span> <span class="s2">&quot;project_data&quot;</span> <span class="ow">in</span> <span class="n">model_doc</span><span class="p">:</span>
              <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Removing PD from none parameter-space model&quot;</span><span class="p">)</span>
              <span class="k">del</span> <span class="n">model_doc</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]</span>
              <span class="n">couchdb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model_doc</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">delete_pd</span><span class="p">:</span>
          <span class="c1"># delete the bad project data</span>
          <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pd_doc</span><span class="p">)</span>
          <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Deleting PD::: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;ok&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="clear_ssh_sessions"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.clear_ssh_sessions">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">clear_ssh_sessions</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  clears out of the ssh session for the current user</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
      <span class="k">if</span> <span class="s2">&quot;slycatauth&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">:</span>
          <span class="n">sid</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
          <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
          <span class="n">session</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
          <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ssh sessions cleared for user session: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">session</span><span class="p">)</span>
          <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;200&quot;</span>
          <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="k">for</span> <span class="n">ssh_session</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]:</span>
                  <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;sessions </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ssh_session</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">])</span>
                  <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">ssh_session</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">])</span>
              <span class="n">session</span><span class="p">[</span><span class="s1">&#39;sessions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
              <span class="n">couchdb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;403 Forbidden&quot;</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Bad Request&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span><span class="s2">&quot;ok&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="put_model_inputs"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_model_inputs">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_model_inputs</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">sid</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span>
    <span class="n">deep_copy</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deep-copy&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model_inputs&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 cannot duplicate a model from another project.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Cannot duplicate a model from another project.&quot;</span><span class="p">)</span>

    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_model_inputs</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">deep_copy</span><span class="p">)</span></div>

<div class="viewcode-block" id="put_project_data_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_project_data_parameter">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_project_data_parameter</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="c1"># project_data = database.get(&quot;project-data&quot;, did)</span>
    <span class="c1"># Alex changing dash to underscore, otherwise this breaks</span>
    <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">require_boolean_json_parameter</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">db_lock</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_project_data_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">project_data</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">require_boolean_json_parameter</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
            <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_project_data_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">project_data</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span></div>


<div class="viewcode-block" id="put_model_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_model_parameter">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_model_parameter</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">require_boolean_json_parameter</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">db_lock</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_model_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
            <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">require_boolean_json_parameter</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
            <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_model_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span></div>

<div class="viewcode-block" id="delete_model_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_model_parameter">[docs]</a><span class="k">def</span> <span class="nf">delete_model_parameter</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    delete a model artifact </span>
<span class="sd">    :param mid: model Id</span>
<span class="sd">    :param aid: artifact id</span>
<span class="sd">    :return: </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">delete_model_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">cleanup</span><span class="o">.</span><span class="n">arrays</span><span class="p">()</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Model deleted.&quot;</span></div>


<div class="viewcode-block" id="put_model_arrayset"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_model_arrayset">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_model_arrayset</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="nb">input</span> <span class="o">=</span> <span class="n">require_boolean_json_parameter</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>

    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_model_arrayset</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span></div>


<div class="viewcode-block" id="put_model_arrayset_array"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_model_arrayset_array">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">put_model_arrayset_array</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="c1"># Sanity-check inputs ...</span>
    <span class="n">array_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span>
    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;dimensions&quot;</span><span class="p">]</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">put_model_array</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array_index</span><span class="p">,</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span></div>


<div class="viewcode-block" id="put_model_arrayset_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.put_model_arrayset_data">[docs]</a><span class="k">def</span> <span class="nf">put_model_arrayset_data</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Validate inputs.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hyperchunks</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">hyperchunks</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model_arrayset_data&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a valid hyperchunks specification.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model_arrayset_data&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 optional byteorder argument must be big or little.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 optional byteorder argument must be big or little.&quot;</span><span class="p">)</span>

    <span class="c1"># Handle the request.</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_model</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Storing data to array set </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">file</span><span class="p">)</span>
        <span class="n">data_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">],</span> <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">hdf5_arrayset</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">ArraySet</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">arrays</span><span class="p">(</span><span class="n">hyperchunks</span><span class="p">,</span> <span class="n">hdf5_arrayset</span><span class="o">.</span><span class="n">array_count</span><span class="p">()):</span>
                <span class="n">hdf5_array</span> <span class="o">=</span> <span class="n">hdf5_arrayset</span><span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">array</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdf5_array</span><span class="o">.</span><span class="n">attributes</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">AttributeIndex</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Cannot assign data to computed attributes.&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">hyperslice</span> <span class="ow">in</span> <span class="n">attribute</span><span class="o">.</span><span class="n">hyperslices</span><span class="p">():</span>
                        <span class="c1">#cherrypy.log.error(</span>
                        <span class="c1">#    &quot;Writing %s/%s/%s/%s&quot; % (aid, array.index, attribute.expression.index, hyperslice))</span>

                        <span class="c1"># We have to convert our hyperslice into a shape with explicit extents so we can compute</span>
                        <span class="c1"># how many bytes to extract from the input data.</span>
                        <span class="k">if</span> <span class="n">hyperslice</span> <span class="o">==</span> <span class="p">(</span><span class="bp">Ellipsis</span><span class="p">,):</span>
                            <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">dimension</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dimension</span><span class="p">[</span><span class="s2">&quot;begin&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dimension</span> <span class="ow">in</span> <span class="n">hdf5_array</span><span class="o">.</span><span class="n">dimensions</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">hyperslice_dimension</span><span class="p">,</span> <span class="n">array_dimension</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hyperslice</span><span class="p">,</span> <span class="n">hdf5_array</span><span class="o">.</span><span class="n">dimensions</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hyperslice_dimension</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
                                    <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hyperslice_dimension</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">Ellipsis</span><span class="p">)):</span>
                                    <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array_dimension</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">array_dimension</span><span class="p">[</span><span class="s2">&quot;begin&quot;</span><span class="p">])</span>
                                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hyperslice_dimension</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                                    <span class="c1"># TODO: Handle step</span>
                                    <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">hyperslice_dimension</span><span class="o">.</span><span class="n">indices</span><span class="p">(</span>
                                        <span class="n">array_dimension</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">array_dimension</span><span class="p">[</span><span class="s2">&quot;begin&quot;</span><span class="p">])</span>
                                    <span class="n">data_shape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model_arrayset_data&quot;</span><span class="p">,</span>
                                                            <span class="s2">&quot;Unexpected hyperslice: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hyperslice_dimension</span><span class="p">)</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unexpected hyperslice: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">hyperslice_dimension</span><span class="p">)</span>

                        <span class="c1"># Convert data to an array ...</span>
                        <span class="n">data_type</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">hdf5_array</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                        <span class="n">data_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">hyperslice_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">data_iterator</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_type</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_shape</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">byteorder</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span><span class="p">:</span>
                            <span class="n">hyperslice_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">data_size</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="n">data_shape</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py put_model_arrayset_data&quot;</span><span class="p">,</span>
                                                    <span class="s2">&quot;Not implemented error.&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

                        <span class="n">hdf5_array</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">attribute</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">hyperslice</span><span class="p">,</span> <span class="n">hyperslice_data</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_project_data_in_model"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_project_data_in_model">[docs]</a><span class="k">def</span> <span class="nf">delete_project_data_in_model</span><span class="p">(</span><span class="n">did</span><span class="p">,</span> <span class="n">mid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes a project data id from a model.</span>

<span class="sd">    :param did: Project data id</span>
<span class="sd">    :param mid: Model id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_lock</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">model_did</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">model_did</span> <span class="o">==</span> <span class="n">did</span><span class="p">:</span>
                <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project_data&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
            <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Project data removed from model.&quot;</span></div>

<div class="viewcode-block" id="delete_model_in_project_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_model_in_project_data">[docs]</a><span class="k">def</span> <span class="nf">delete_model_in_project_data</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">did</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes a model id from project data.</span>

<span class="sd">    :param mid: Model id</span>
<span class="sd">    :param did: Project data id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project_data</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project_data&quot;</span><span class="p">,</span> <span class="n">did</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_project_data_lock</span><span class="p">(</span><span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">pd_mid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">pd_mid</span> <span class="o">==</span> <span class="n">mid</span><span class="p">:</span>
                <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">del</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
                <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">project_data</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Model removed from project data.&quot;</span></div>

<div class="viewcode-block" id="delete_model"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_model">[docs]</a><span class="k">def</span> <span class="nf">delete_model</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
    <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">project_data</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project_datas&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">],</span> <span class="n">endkey</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]):</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_project_data_lock</span><span class="p">(</span><span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">pd_mid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">pd_mid</span> <span class="o">==</span> <span class="n">mid</span><span class="p">:</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">del</span> <span class="n">project_data</span><span class="p">[</span><span class="s2">&quot;mid&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">updated</span><span class="p">:</span>
                <span class="n">couchdb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">project_data</span><span class="p">)</span>

    <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">cleanup</span><span class="o">.</span><span class="n">arrays</span><span class="p">()</span>


    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Model deleted.&quot;</span></div>


<div class="viewcode-block" id="delete_reference"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_reference">[docs]</a><span class="k">def</span> <span class="nf">delete_reference</span><span class="p">(</span><span class="n">rid</span><span class="p">):</span>
    <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">,</span> <span class="n">rid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">reference</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Reference deleted.&quot;</span></div>


<div class="viewcode-block" id="get_project_cache_object"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_project_cache_object">[docs]</a><span class="k">def</span> <span class="nf">get_project_cache_object</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves an object from a projects cache. </span>
<span class="sd">    Cache objects are opaque binary blobs that </span>
<span class="sd">    may contain arbitrary data, plus an explicit </span>
<span class="sd">    content type.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        pid {string} -- project id</span>
<span class="sd">        key {string} -- string key for obj</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 404 not found</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        attachment from database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">lookup</span> <span class="o">=</span> <span class="n">pid</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">key</span>
    <span class="k">for</span> <span class="n">cache_object</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-key-cache-objects&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">lookup</span><span class="p">):</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache_object</span><span class="p">[</span><span class="s2">&quot;_attachments&quot;</span><span class="p">][</span><span class="s2">&quot;content&quot;</span><span class="p">][</span><span class="s2">&quot;content_type&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">get_attachment</span><span class="p">(</span><span class="n">cache_object</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span>

    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_project_cache_object"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_project_cache_object">[docs]</a><span class="k">def</span> <span class="nf">delete_project_cache_object</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes an object from the project cache.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        pid {string} -- project id</span>
<span class="sd">        key {string} -- key in the cache</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 404 not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_writer</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">lookup</span> <span class="o">=</span> <span class="n">pid</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">key</span>
    <span class="k">for</span> <span class="n">cache_object</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-key-cache-objects&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">lookup</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">lookup</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_object</span><span class="p">)</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Cache object deleted.&quot;</span>
        <span class="k">return</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py delete_project_cache_object&quot;</span><span class="p">,</span> <span class="s2">&quot;cherrypy.HTTPError 404&quot;</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_project_cache"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_project_cache">[docs]</a><span class="k">def</span> <span class="nf">delete_project_cache</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    clears all the cached images and videos for a project</span>
<span class="sd">    given a project ID</span>
<span class="sd">    :param pid: Project ID</span>
<span class="sd">    :return: status</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">couchdb</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_administrator</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cache_object</span> <span class="ow">in</span> <span class="n">couchdb</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;slycat/project-cache-objects&quot;</span><span class="p">,</span> <span class="n">startkey</span><span class="o">=</span><span class="n">pid</span><span class="p">,</span> <span class="n">endkey</span><span class="o">=</span><span class="n">pid</span><span class="p">):</span>
        <span class="n">couchdb</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cache_object</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Cache objects deleted.&quot;</span></div>


<div class="viewcode-block" id="get_model_array_attribute_chunk"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_array_attribute_chunk">[docs]</a><span class="k">def</span> <span class="nf">get_model_array_attribute_chunk</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">attribute</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Malformed attribute argument must be a zero-based integer attribute index.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">[</span><span class="s2">&quot;ranges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
            <span class="s2">&quot;400 Malformed ranges argument must be a comma separated collection of half-open index ranges.&quot;</span><span class="p">)</span>

    <span class="n">byteorder</span> <span class="o">=</span> <span class="n">arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;byteorder&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Malformed byteorder argument must be &#39;little&#39; or &#39;big&#39;.&quot;</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/json&quot;</span><span class="p">])</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accept</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">hdf5_arrayset</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">ArraySet</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">hdf5_array</span> <span class="o">=</span> <span class="n">hdf5_arrayset</span><span class="p">[</span><span class="n">array</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">attribute</span> <span class="ow">and</span> <span class="n">attribute</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdf5_array</span><span class="o">.</span><span class="n">attributes</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Attribute argument out-of-range.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hdf5_array</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Ranges argument doesn&#39;t contain the correct number of dimensions.&quot;</span><span class="p">)</span>

            <span class="n">ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">max</span><span class="p">(</span><span class="n">dimension</span><span class="p">[</span><span class="s2">&quot;begin&quot;</span><span class="p">],</span> <span class="nb">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">dimension</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span> <span class="nb">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">dimension</span><span class="p">,</span> <span class="nb">range</span> <span class="ow">in</span>
                      <span class="nb">zip</span><span class="p">(</span><span class="n">hdf5_array</span><span class="o">.</span><span class="n">dimensions</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">slice</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">])</span>

            <span class="n">attribute_type</span> <span class="o">=</span> <span class="n">hdf5_array</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">attribute</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">hdf5_array</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">attribute</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MyEncoder</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="n">byteorder</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_model_arrayset_metadata"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_arrayset_metadata">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_model_arrayset_metadata</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to retrieve metadata and statistics for an arrayset artifact</span>
<span class="sd">    - a collection of dense, multidimensional darray objects. A darray</span>
<span class="sd">    is a dense, multi-dimensional, multi-attribute array,</span>
<span class="sd">    suitable for storage of arbitrarily-large data.</span>

<span class="sd">    The metadata for a single darray includes the name, type,</span>
<span class="sd">    half-open range of coordinate values, and shape for each</span>
<span class="sd">    dimension in the array, plus the name and type of each attribute.</span>

<span class="sd">    Statistics can be retrieved for individual darray attributes, and</span>
<span class="sd">    include minimum and maximum values, plus a count of unique</span>
<span class="sd">    values for an attribute. Although statistics are cached, retrieving</span>
<span class="sd">    them may be an extremely expensive operation, since they involve</span>
<span class="sd">    full scans through their respective attributes. Because of this,</span>
<span class="sd">    callers are encouraged to retrieve statistics only when needed.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>
<span class="sd">        aid {string} -- artifact id</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 404</span>
<span class="sd">        cherrypy.HTTPError: 400 aid is not an array artifact.</span>
<span class="sd">        cherrypy.HTTPError: 400 Not a valid hyperchunks specification.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json -- statistical results of arrayset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;GET arrayset metadata mid:</span><span class="si">%s</span><span class="s2"> aid:</span><span class="si">%s</span><span class="s2"> kwargs:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 artifact is None for aid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;arrays&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;arrays&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a valid hyperchunks specification.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">statistics</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;statistics&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;statistics&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a valid hyperchunks specification.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;unique&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;GET arrayset metadata arrays:</span><span class="si">%s</span><span class="s2"> stats:</span><span class="si">%s</span><span class="s2"> unique:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">statistics</span><span class="p">,</span> <span class="n">unique</span><span class="p">))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_arrayset_metadata</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">statistics</span><span class="p">,</span> <span class="n">unique</span><span class="p">)</span>
    <span class="c1">#cherrypy.log.error(&quot;GOT RESULTS&quot;)</span>
    <span class="k">if</span> <span class="s2">&quot;unique&quot;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1">#cherrypy.log.error( &#39;\n&#39;.join(str(p) for p in results[&quot;unique&quot;]) )</span>
        <span class="c1">#cherrypy.log.error(&quot;type:&quot;)</span>
        <span class="c1">#cherrypy.log.error(str(type(results[&quot;unique&quot;][0][&#39;values&#39;][0])))</span>
        <span class="k">for</span> <span class="n">unique</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">]:</span>
            <span class="c1"># Maybe due to caching, sometimes the result comes back as a &#39;list&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
              <span class="n">unique</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">list_of_values</span> <span class="k">for</span> <span class="n">list_of_values</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]]</span>
            <span class="c1"># Other times it&#39;s a &#39;numpy.ndarray&#39;</span>
            <span class="k">else</span><span class="p">:</span>
              <span class="n">unique</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]]</span>
    <span class="c1"># have to load and dump to clean out all the non json serializable numpy arrays</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MyEncoder</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_model_arrayset_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_arrayset_data">[docs]</a><span class="k">def</span> <span class="nf">get_model_arrayset_data</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve data stored in arrayset darray attributes. The caller </span>
<span class="sd">    may request data stored using any combination of </span>
<span class="sd">    arrays, attributes, and hyperslices.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>
<span class="sd">        aid {string} -- artifact id</span>
<span class="sd">        hyperchunks {string} -- The request must contain a parameter </span>
<span class="sd">          hyperchunks that specifies the arrays, attributes, </span>
<span class="sd">          and hyperslices to be returned, in Hyperchunks format.</span>
<span class="sd">    </span>
<span class="sd">    Keyword Arguments:</span>
<span class="sd">        byteorder {string} -- optional byteorder argument must </span>
<span class="sd">          be big or little. (default: {None})</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 400 aid is not an array artifact.</span>
<span class="sd">        cherrypy.HTTPError: 400 Not a valid hyperchunks specification</span>
<span class="sd">        cherrypy.HTTPError: 400 optional byteorder argument must be big or little.</span>
<span class="sd">        cherrypy.HTTPError: 404 aid not found</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        octet-stream -- application/octet-stream</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;GET Model Arrayset Data: arrayset </span><span class="si">%s</span><span class="s2"> hyperchunks </span><span class="si">%s</span><span class="s2"> byteorder </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hyperchunks</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">hyperchunks</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a valid hyperchunks specification.</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 optional byteorder argument must be big or little.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 optional byteorder argument must be big or little.&quot;</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/json&quot;</span><span class="p">])</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accept</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span> <span class="s2">&quot;cherrypy.HTTPError 404&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mask_nans</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an array containing nans into a masked array.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="n">array</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">array</span>
    <span class="k">def</span> <span class="nf">content</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">mask_nans</span><span class="p">(</span><span class="n">hyperslice</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">hyperslice</span> <span class="ow">in</span>
                              <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_arrayset_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">)])</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hyperslice</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_arrayset_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="n">byteorder</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">hyperslice</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">hyperslice</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">content</span><span class="p">()</span></div>


<span class="n">get_model_arrayset_data</span><span class="o">.</span><span class="n">_cp_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;response.stream&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>


<div class="viewcode-block" id="post_model_arrayset_data"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_model_arrayset_data">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_model_arrayset_data</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  get the arrayset data based on aid, mid, byteorder, and hyperchunks</span>

<span class="sd">  requires hyperchunks to be included in the json payload</span>

<span class="sd">  :param mid: model id</span>
<span class="sd">  :param aid: artifact id</span>
<span class="sd">  :return: stream of data</span>
<span class="sd">  &quot;&quot;&quot;</span>
    <span class="c1"># try and grab hyperchunk</span>
    <span class="n">hyperchunks</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">byteorder</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">require_json_parameter</span><span class="p">(</span><span class="s2">&quot;hyperchunks&quot;</span><span class="p">)</span>
    <span class="n">hyperchunks</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;hyperchunks&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;byteorder&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">byteorder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#cherrypy.log.error(&quot;no byteorder provided moving on&quot;)</span>

    <span class="c1"># parse the hyperchunks</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;GET Model Arrayset Data: arrayset </span><span class="si">%s</span><span class="s2"> hyperchunks </span><span class="si">%s</span><span class="s2"> byteorder </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">,</span> <span class="n">byteorder</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hyperchunks</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hyperchunks</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">hyperchunks</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a valid hyperchunks specification.&quot;</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;GET Model Arrayset Data: arrayset </span><span class="si">%s</span><span class="s2"> hyperchunks calculated&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">))</span>

    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;big&quot;</span><span class="p">,</span> <span class="s2">&quot;little&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 optional byteorder argument must be big or little.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 optional byteorder argument must be big or little.&quot;</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/json&quot;</span><span class="p">])</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accept</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span> <span class="s2">&quot;cherrypy.HTTPError 404&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_arrayset_data&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mask_nans</span><span class="p">(</span><span class="n">array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert an array containing nans into a masked array.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="n">array</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">array</span>

    <span class="k">def</span> <span class="nf">content</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;include_nans&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">:</span>
            <span class="n">include_nans</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;include_nans&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">([</span><span class="n">mask_nans</span><span class="p">(</span><span class="n">hyperslice</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">hyperslice</span> <span class="ow">in</span>
                              <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_arrayset_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">)])</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">hyperslice</span> <span class="ow">in</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_arrayset_data</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">hyperchunks</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="n">byteorder</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">hyperslice</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">hyperslice</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;GET Model Arrayset Data: arrayset </span><span class="si">%s</span><span class="s2"> starting to get content&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aid</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">content</span><span class="p">()</span></div>


<span class="c1"># TODO: streaming was turned off because this is now a post, in the future we may wan to turn this back on to increase speed</span>
<span class="c1"># post_model_arrayset_data._cp_config = {&quot;response.stream&quot; : True}</span>

<div class="viewcode-block" id="validate_table_rows"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.validate_table_rows">[docs]</a><span class="k">def</span> <span class="nf">validate_table_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">rows</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rows</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_rows&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 malformed rows argument must be a comma separated collection of row indices or half-open index ranges.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
            <span class="s2">&quot;400 Malformed rows argument must be a comma separated collection of row indices or half-open index ranges.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_rows&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 row values must be non-negative.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Row values must be non-negative.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rows</span></div>


<div class="viewcode-block" id="validate_table_columns"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.validate_table_columns">[docs]</a><span class="k">def</span> <span class="nf">validate_table_columns</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">columns</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">columns</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_columns&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 malformed columns argument must be a comma separated collection of column indices or half-open index ranges.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
            <span class="s2">&quot;400 Malformed columns argument must be a comma separated collection of column indices or half-open index ranges.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">columns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_columns&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 column values must be non-negative.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Column values must be non-negative.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">columns</span></div>


<div class="viewcode-block" id="validate_table_sort"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.validate_table_sort">[docs]</a><span class="k">def</span> <span class="nf">validate_table_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">sort</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="p">[(</span><span class="n">column</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_sort&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 malformed order argument must be a comma separated collection of column:order tuples.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span>
                <span class="s2">&quot;400 Malformed order argument must be a comma separated collection of column:order tuples.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sort</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">int</span><span class="p">(</span><span class="n">column</span><span class="p">),</span> <span class="n">order</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_sort&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 sort column must be an integer.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Sort column must be an integer.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_sort&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 sort column must be non-negative.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Sort column must be non-negative.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ascending&quot;</span><span class="p">,</span> <span class="s2">&quot;descending&quot;</span><span class="p">]:</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_sort&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 sort-order must be &#39;ascending&#39; or &#39;descending&#39;&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Sort-order must be &#39;ascending&#39; or &#39;descending&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_sort&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 currently, only one column can be sorted.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Currently, only one column can be sorted.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sort</span></div>


<div class="viewcode-block" id="validate_table_byteorder"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.validate_table_byteorder">[docs]</a><span class="k">def</span> <span class="nf">validate_table_byteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="s2">&quot;big&quot;</span><span class="p">]:</span>
            <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py validate_table_sort&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;cherrypy.HTTPError 400 malformed byteorder argument must be &#39;little&#39; or &#39;big&#39;.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Malformed byteorder argument must be &#39;little&#39; or &#39;big&#39;.&quot;</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">([</span><span class="s2">&quot;application/json&quot;</span><span class="p">])</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accept</span>
    <span class="k">return</span> <span class="n">byteorder</span></div>


<div class="viewcode-block" id="get_table_sort_index"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_table_sort_index">[docs]</a><span class="k">def</span> <span class="nf">get_table_sort_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">array_index</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">sort_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;row-count&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sort_column</span><span class="p">,</span> <span class="n">sort_order</span> <span class="o">=</span> <span class="n">sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sort_column</span> <span class="o">==</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># At this point, the sort index is already set from above</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_key</span> <span class="o">=</span> <span class="s2">&quot;array/</span><span class="si">%s</span><span class="s2">/index/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">array_index</span><span class="p">,</span> <span class="n">sort_column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="c1"># cherrypy.log.error(&quot;Caching array index for file %s array %s attribute %s&quot; % (file.filename, array_index, sort_column))</span>
                <span class="n">sort_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">ArraySet</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="n">array_index</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">sort_column</span><span class="p">)[</span><span class="o">...</span><span class="p">],</span>
                                           <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
                <span class="n">file</span><span class="p">[</span><span class="n">index_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># cherrypy.log.error(&quot;Loading cached sort index.&quot;)</span>
                <span class="n">sort_index</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="n">index_key</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="s2">&quot;descending&quot;</span><span class="p">:</span>
            <span class="n">sort_index</span> <span class="o">=</span> <span class="n">sort_index</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sort_index</span></div>


<div class="viewcode-block" id="get_table_metadata"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_table_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_table_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">array_index</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return table-oriented metadata for a 1D array, plus an optional index column.&quot;&quot;&quot;</span>
    <span class="n">arrayset</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">ArraySet</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">arrayset</span><span class="p">[</span><span class="n">array_index</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_table_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 not a table (1D array) artifact.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Not a table (1D array) artifact.&quot;</span><span class="p">)</span>

    <span class="n">dimensions</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">attributes</span>
    <span class="n">statistics</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span><span class="o">.</span><span class="n">get_statistics</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span> <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">))]</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;row-count&quot;</span><span class="p">:</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;begin&quot;</span><span class="p">],</span>
        <span class="s2">&quot;column-count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">attributes</span><span class="p">),</span>
        <span class="s2">&quot;column-names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">attribute</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">],</span>
        <span class="s2">&quot;column-types&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">attribute</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">],</span>
        <span class="s2">&quot;column-min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">attribute</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">statistics</span><span class="p">],</span>
        <span class="s2">&quot;column-max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">attribute</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">statistics</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-types&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;row-count&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metadata</span></div>


<div class="viewcode-block" id="get_model_table_metadata"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_table_metadata">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_model_table_metadata</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 artifact is None for aid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_metadata&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span>
                                         <span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>  <span class="c1"># We have to open the file with writing enabled because the statistics cache may need to be updated.</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_table_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="c1"># have to load and dump to clean out all the non json serializable numpy arrays</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MyEncoder</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_model_table_chunk"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_table_chunk">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_model_table_chunk</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">validate_table_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">validate_table_columns</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">validate_table_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_chunk&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 artifact is None for aid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_chunk&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_table_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

            <span class="c1"># Constrain end &lt;= count along both dimensions</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;row-count&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">columns</span> <span class="o">&gt;=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]):</span>
                <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_chunk&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;cherrypy.HTTPError 400 column out-of-range.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Column out-of-range.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="o">&gt;=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]:</span>
                        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_chunk&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;400 sort column out-of-range.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Sort column out-of-range.&quot;</span><span class="p">)</span>

            <span class="c1"># Retrieve the data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sort_index</span> <span class="o">=</span> <span class="n">get_table_sort_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="nb">slice</span> <span class="o">=</span> <span class="n">sort_index</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span>
            <span class="n">slice_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
            <span class="n">slice_reverse_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">slice_index</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-types&quot;</span><span class="p">][</span><span class="n">column</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">column</span> <span class="o">==</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">slice</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">ArraySet</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="n">array</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">column</span><span class="p">)[</span><span class="nb">slice</span><span class="p">[</span><span class="n">slice_index</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()][</span>
                        <span class="n">slice_reverse_index</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="s2">&quot;float64&quot;</span><span class="p">]:</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="n">rows</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s2">&quot;column-names&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-names&quot;</span><span class="p">][</span><span class="n">column</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">],</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="n">sort</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="get_model_table_sorted_indices"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_table_sorted_indices">[docs]</a><span class="k">def</span> <span class="nf">get_model_table_sorted_indices</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">validate_table_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">validate_table_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
    <span class="n">byteorder</span> <span class="o">=</span> <span class="n">validate_table_byteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_sorted_indices&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 artifact is None for aid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_sorted_indices&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_table_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

            <span class="c1"># Constrain end &lt;= count along both dimensions</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;row-count&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="o">&gt;=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]:</span>
                        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_sorted_indices&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;cherrypy.HTTPError 400 sort column out-of-range.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Sort column out-of-range.&quot;</span><span class="p">)</span>

            <span class="c1"># Retrieve the data ...</span>
            <span class="n">sort_index</span> <span class="o">=</span> <span class="n">get_table_sort_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="nb">slice</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sort_index</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;mergesort&quot;</span><span class="p">)[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">slice</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="n">byteorder</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">slice</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">slice</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_model_table_unsorted_indices"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_table_unsorted_indices">[docs]</a><span class="k">def</span> <span class="nf">get_model_table_unsorted_indices</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">validate_table_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">validate_table_sort</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
    <span class="n">byteorder</span> <span class="o">=</span> <span class="n">validate_table_byteorder</span><span class="p">(</span><span class="n">byteorder</span><span class="p">)</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_unsorted_indices&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 artifact is None for aid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hdf5&quot;</span><span class="p">]:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_unsorted_indices&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not an array artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">hdf5</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">artifact</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">get_table_metadata</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

            <span class="c1"># Constrain end &lt;= count along both dimensions</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;row-count&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">sort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span><span class="p">,</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">sort</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="o">&gt;=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;column-count&quot;</span><span class="p">]:</span>
                        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_table_unsorted_indices&quot;</span><span class="p">,</span>
                                                <span class="s2">&quot;cherrypy.HTTPError 400 sort column out-of-range.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 Sort column out-of-range.&quot;</span><span class="p">)</span>

            <span class="c1"># Generate a database query</span>
            <span class="n">sort_index</span> <span class="o">=</span> <span class="n">get_table_sort_index</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="nb">slice</span> <span class="o">=</span> <span class="n">sort_index</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">byteorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">slice</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">!=</span> <span class="n">byteorder</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">slice</span><span class="o">.</span><span class="n">byteswap</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">slice</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_model_file"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_file">[docs]</a><span class="k">def</span> <span class="nf">get_model_file</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  </span>
<span class="sd">    Retrieves a file artifact from a model. File artifacts are effectively</span>
<span class="sd">    binary blobs that may contain arbitrary data with an explicit content</span>
<span class="sd">    type.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>
<span class="sd">        aid {string} -- artifact id</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 404</span>
<span class="sd">        cherrypy.HTTPError: 400 aid is not a file artifact.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        any -- file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">artifact</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">artifact</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_file&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 artifact is None for aid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="n">artifact_type</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">][</span><span class="n">aid</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">artifact_type</span> <span class="o">!=</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_file&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 400 </span><span class="si">%s</span><span class="s2"> is not a file artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 </span><span class="si">%s</span><span class="s2"> is not a file artifact.&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">artifact</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;_attachments&quot;</span><span class="p">][</span><span class="n">fid</span><span class="p">][</span><span class="s2">&quot;content_type&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">get_attachment</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_model_parameter"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_parameter">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_model_parameter</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="n">aid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a model parameter (name / value pair) artifact. The result is a</span>
<span class="sd">    JSON expression and may be arbitrarily complex.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        mid {string} -- model id</span>
<span class="sd">        aid {string} -- artifact id</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        cherrypy.HTTPError: 404 Unknown artifact</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_model_parameter</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">aid</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_model_parameter&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 unknown artifact: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 Unknown artifact: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">aid</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_bookmark"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_bookmark">[docs]</a><span class="k">def</span> <span class="nf">get_bookmark</span><span class="p">(</span><span class="n">bid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a bookmark - an arbitrary collection of client state.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        bid {string} -- bookmark id</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        json -- representation of client state</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">accept</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cptools</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="n">media</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;application/json&quot;</span><span class="p">])</span>

    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">bookmark</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bookmark&quot;</span><span class="p">,</span> <span class="n">bid</span><span class="p">)</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">bookmark</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;content-type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accept</span>
    <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">get_attachment</span><span class="p">(</span><span class="n">bookmark</span><span class="p">,</span> <span class="s2">&quot;bookmark&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_user"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_user">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve directory information for a given user.</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">      uid {string} -- users id</span>
<span class="sd">      time {int} -- time int to prevent caching</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">      cherrypy.HTTPError: 404 user not found</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">      json -- user info</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;directory&quot;</span><span class="p">](</span><span class="n">uid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;slycat.web.server.handlers.py get_user&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;cherrypy.HTTPError 404 user is None for uid: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">uid</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="c1"># Add the uid to the record, since the caller may not know it.</span>
    <span class="n">user</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span>
    <span class="k">return</span> <span class="n">user</span></div>


<div class="viewcode-block" id="get_model_statistics"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_model_statistics">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_model_statistics</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    gets statistics on the model</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">      mid {string} -- model ID</span>
<span class="sd">      time {int} -- time int to prevent caching</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">      cherrypy.HTTPError: 404 user not found</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">      mid {string} -- mid</span>
<span class="sd">      hdf5_file_size {float} -- hdf5_file_size</span>
<span class="sd">      total_server_data_size {float} -- total_server_data_size</span>
<span class="sd">      hdf5_store_size {float} -- total_hdf5_server_size</span>
<span class="sd">      model {string} -- model</span>
<span class="sd">      delta_creation_time {float} -- delta_creation_time</span>
<span class="sd">      couchdb_doc_size {float} -- sys.getsizeof(model)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;404 error: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mid</span><span class="p">)</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">authentication</span><span class="o">.</span><span class="n">require_project_reader</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>

    <span class="c1"># amount of time it took to make the model</span>
    <span class="k">if</span> <span class="s2">&quot;finished&quot;</span> <span class="ow">in</span> <span class="n">model</span> <span class="ow">and</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">delta_creation_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">model</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span>
                <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_creation_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="s2">&quot;job_running_time&quot;</span> <span class="ow">in</span> <span class="n">model</span> <span class="ow">and</span> <span class="s2">&quot;artifact:job_submit_time&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">delta_queue_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;job_running_time&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact:job_submit_time&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_queue_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="s2">&quot;job_completed_time&quot;</span> <span class="ow">in</span> <span class="n">model</span> <span class="ow">and</span> <span class="s2">&quot;job_running_time&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">delta_running_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;job_completed_time&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">model</span><span class="p">[</span><span class="s2">&quot;job_running_time&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">delta_model_compute_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">model</span><span class="p">[</span><span class="s2">&quot;model_compute_time&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
    <span class="k">elif</span> <span class="s2">&quot;job_completed_time&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">:</span>
        <span class="n">delta_running_time</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;job_completed_time&quot;</span><span class="p">],</span>
                                       <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">model</span><span class="p">[</span><span class="s2">&quot;finished&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">delta_model_compute_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delta_running_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">delta_model_compute_time</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># get hdf5 root dir</span>
    <span class="n">hdf5_root_directory</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">apps</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;data-store&quot;</span><span class="p">]</span>

    <span class="c1"># get models hdf5 footprint</span>
    <span class="n">hdf5_file_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact-types&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;hdf5&quot;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;artifact:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">]</span>
            <span class="n">hdf5_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hdf5_root_directory</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">array</span> <span class="o">+</span> <span class="s2">&quot;.hdf5&quot;</span><span class="p">)</span>
            <span class="n">hdf5_file_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">hdf5_file_path</span><span class="p">)</span>

    <span class="c1"># calc total model server data footprint</span>
    <span class="n">total_server_data_size</span> <span class="o">=</span> <span class="n">hdf5_file_size</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># get total hdf5 file store size for server</span>
    <span class="n">total_hdf5_server_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">hdf5_root_directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">total_hdf5_server_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">server_cache_size</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">_pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_cache</span><span class="o">.</span><span class="n">cache</span><span class="p">)))</span> <span class="o">/</span> <span class="mf">1024.0</span> <span class="o">/</span> <span class="mf">1024.0</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">server_cache_size</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;server_cache_size&quot;</span><span class="p">:</span> <span class="n">server_cache_size</span><span class="p">,</span>
        <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="n">mid</span><span class="p">,</span>
        <span class="s2">&quot;hdf5_file_size&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">hdf5_file_size</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1024.0</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">,</span>
        <span class="s2">&quot;total_server_data_size&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_server_data_size</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1024.0</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">,</span>
        <span class="s2">&quot;hdf5_store_size&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_hdf5_server_size</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1024.0</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">,</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
        <span class="s2">&quot;delta_creation_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_creation_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;couchdb_doc_size&quot;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1024.0</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">,</span>
        <span class="s2">&quot;hdf5_footprint&quot;</span><span class="p">:</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">hdf5_file_size</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_hdf5_server_size</span><span class="p">)),</span>
        <span class="s2">&quot;job_pending_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_queue_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;job_running_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_running_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;model_compute_time&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">delta_model_compute_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;analysis_computation_time&quot;</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="s2">&quot;analysis_computation_time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">model</span><span class="p">[</span><span class="s2">&quot;analysis_computation_time&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;db_creation_time&quot;</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="s2">&quot;db_creation_time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;db_creation_time&quot;</span><span class="p">])</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="post_remotes"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_remotes">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_remotes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Given username, hostname, password as a json payload</span>
<span class="sd">      establishes a session with the remote host and attaches</span>
<span class="sd">      it to the users session</span>
<span class="sd">      :return: {&quot;sid&quot;:sid, &quot;status&quot;:boolean, msg:&quot;&quot;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">]</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
    <span class="c1"># username/password are not guaranteed to exist within the incoming json</span>
    <span class="c1"># (they don&#39;t exist for rsa-cert auth)</span>
    <span class="k">if</span> <span class="n">username</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">login</span>
        
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">agent</span><span class="p">)</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    save sid to user session</span>
<span class="sd">    the session will be stored as follows in the users session</span>
<span class="sd">    {sessions:[{{&quot;sid&quot;: sid,&quot;hostname&quot;: hostname, &quot;username&quot;: username}},...]}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">])):</span>
            <span class="k">if</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hostname</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="s2">&quot;sid&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;sid&quot;</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;sid&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
        <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;login could not save session for remotes </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;login could not save session for remote host&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;sid&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_remotes"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remotes">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_remotes</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns {status: True} if the hostname was found in the user&#39;s</span>
<span class="sd">    session</span>
<span class="sd">    :param hostname: connection host name</span>
<span class="sd">    :return: {&quot;status&quot;:status, &quot;msg&quot;:msg}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hostname session not found&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">couchdb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">cookie</span><span class="p">[</span><span class="s2">&quot;slycatauth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">h_session</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">h_session</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hostname</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">check_session</span><span class="p">(</span><span class="n">h_session</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hostname session was found&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">session</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">tup</span><span class="p">[</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hostname</span><span class="p">]</span>
                    <span class="n">database</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;status could not save session for remotes </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;hostName&quot;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_remote_show_user_password"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remote_show_user_password">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_remote_show_user_password</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    checks to see if the application needs to show password</span>
<span class="sd">    :return: json {show:bool, msg:msg}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ssh</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">slycat_pass</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
    <span class="k">if</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;remote-authentication&quot;</span><span class="p">][</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;password auth required for remotes&quot;</span>
    <span class="k">if</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;authentication&quot;</span><span class="p">][</span><span class="s2">&quot;plugin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;slycat-password-authentication&quot;</span><span class="p">:</span>
        <span class="n">slycat_pass</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ssh&quot;</span><span class="p">:</span> <span class="n">ssh</span><span class="p">,</span> <span class="s2">&quot;slycat&quot;</span><span class="p">:</span> <span class="n">slycat_pass</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span></div>


<div class="viewcode-block" id="delete_remote"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_remote">[docs]</a><span class="k">def</span> <span class="nf">delete_remote</span><span class="p">(</span><span class="n">sid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO: this function needs review for deprecation as we no longer send the sid over</span>

<span class="sd">    Deletes a remote session created with POST /api/remotes</span>
<span class="sd">    </span>
<span class="sd">    Arguments:</span>
<span class="sd">        sid {string} -- unique session id</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Remote deleted.&quot;</span></div>


<div class="viewcode-block" id="get_session_status"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_session_status">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_session_status</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;success&quot;</span></div>


<div class="viewcode-block" id="post_remote_launch"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_remote_launch">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_remote_launch</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_submit_batch"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_submit_batch">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_submit_batch</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">submit_batch</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_checkjob"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_checkjob">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_checkjob</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">checkjob</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span></div>


<div class="viewcode-block" id="delete_job"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.delete_job">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">cancel_job</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_job_output"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_job_output">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_job_output</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_job_output</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_user_config"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_user_config">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_user_config</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_user_config</span><span class="p">()</span></div>


<div class="viewcode-block" id="job_time"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.job_time">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">job_time</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    gives the time in seconds recommended given job meta data</span>
<span class="sd">    :param nodes: number of hpc nodes for job</span>
<span class="sd">    :param tasks: number of tasks per node for job</span>
<span class="sd">    :param size: size of data file used in the job</span>
<span class="sd">    :return: json time in seconds as an integer {&#39;time-seconds&#39;: 1800}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.8</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span> <span class="o">+</span> <span class="mi">900</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;time-seconds&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
            <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="n">nodes</span><span class="p">,</span>
            <span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">,</span>
            <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span>
           <span class="p">}</span>  <span class="c1"># return an approximation based on size, nodes, and tasks for now</span></div>


<div class="viewcode-block" id="set_user_config"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.set_user_config">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">set_user_config</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="c1"># TODO add user config mapping</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;user_config </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">set_user_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_remote_command"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_remote_command">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_remote_command</span><span class="p">(</span><span class="n">hostname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    run a remote command from the list of pre-registered commands</span>
<span class="sd">    that are located on a remote agent.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hostname: str</span>
<span class="sd">    name of the hpc host</span>
<span class="sd">    Returns</span>
<span class="sd">    ------- </span>
<span class="sd">    json</span>
<span class="sd">      message: string</span>
<span class="sd">      a message that is supplied by the agent</span>
<span class="sd">      command: string</span>
<span class="sd">      an echo of the command that was sent to the server and the agent,</span>
<span class="sd">      error: bool</span>
<span class="sd">      boolean describing if there was an agent error,</span>
<span class="sd">      available_scripts:  list</span>
<span class="sd">      list of available scripts from the agent</span>
<span class="sd">      name: string</span>
<span class="sd">      script_name</span>
<span class="sd">      description: string</span>
<span class="sd">      script_description</span>
<span class="sd">      parameters: list</span>
<span class="sd">      name: string</span>
<span class="sd">      parameter_name as string,</span>
<span class="sd">      description: string</span>
<span class="sd">      description of the param string,</span>
<span class="sd">      example: string</span>
<span class="sd">      example usage string</span>
<span class="sd">      type: string</span>
<span class="sd">      field type eg string, int...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">run_remote_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_remote_job_status"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remote_job_status">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_remote_job_status</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">jid</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_remote_job_status</span><span class="p">(</span><span class="n">jid</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_remote_browse"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_remote_browse">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_in</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_remote_browse</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="n">file_reject</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file-reject&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="s2">&quot;file-reject&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">file_allow</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file-allow&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="s2">&quot;file-allow&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">directory_reject</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory-reject&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="s2">&quot;directory-reject&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">directory_allow</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directory-allow&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="s2">&quot;directory-allow&quot;</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">json</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_reject</span><span class="p">,</span> <span class="n">file_allow</span><span class="p">,</span> <span class="n">directory_reject</span><span class="p">,</span> <span class="n">directory_allow</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_remote_file"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remote_file">[docs]</a><span class="k">def</span> <span class="nf">get_remote_file</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Uses an existing remote session to retrieve a remote file.  The remote</span>
<span class="sd">      session must have been created using :http:post:`/api/remotes`.  Use</span>
<span class="sd">      :http:post:`/api/remotes/(hostname)/browse(path)` to lookup remote file paths.</span>
<span class="sd">      The returned file may be optionally cached on the server and retrieved</span>
<span class="sd">      using :http:get:`/api/projects/(pid)/cache/(key)`.</span>

<span class="sd">      Parameters</span>
<span class="sd">      ----------</span>
<span class="sd">      hostname: string</span>
<span class="sd">                connection host name</span>
<span class="sd">      path: string</span>
<span class="sd">            path to file</span>
<span class="sd">      kwargs: json</span>
<span class="sd">        cache:  </span>
<span class="sd">          Optional cache identifier. </span>
<span class="sd">          Set to project to store the retrieved file in a project cache.</span>
<span class="sd">        project: uuid</span>
<span class="sd">                 Project identifier. Required when cache is set to project.</span>
<span class="sd">        key: uuid</span>
<span class="sd">             Cached object key. Must be specified when cache is set to project.</span>
<span class="sd">      Returns</span>
<span class="sd">      ------- </span>
<span class="sd">      file: binary</span>
<span class="sd">            the file that was asked for</span>

<span class="sd">      Raises</span>
<span class="sd">      ------</span>
<span class="sd">      200 OK</span>
<span class="sd">        The requested file is returned in the body of the response.</span>
<span class="sd">      404 Not Found</span>
<span class="sd">        The session doesnt exist or has timed-out.</span>
<span class="sd">      400 Bad Request</span>
<span class="sd">        Cant read directory The remote path is a directory instead of a file.</span>
<span class="sd">      400 Bad Request</span>
<span class="sd">        File not found The remote path doesnt exist.</span>
<span class="sd">      400 Bad Request</span>
<span class="sd">        Access denied The session user doesnt have permissions to access the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_remote_image"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remote_image">[docs]</a><span class="k">def</span> <span class="nf">get_remote_image</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a hostname and image path returns the image given</span>
<span class="sd">    by the path</span>
<span class="sd">    :param hostname: connection host name</span>
<span class="sd">    :param path: path to image</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return: image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_image</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="c1">#TODO: clean up everything</span>
<div class="viewcode-block" id="get_time_series_names"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_time_series_names">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_time_series_names</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a time series csv for all column names</span>
<span class="sd">    :param hostname: connection host name</span>
<span class="sd">    :param path: path to csv file</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :return: json object of column names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">csv_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">r</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_file</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">def</span> <span class="nf">_isNumeric</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;</span>
<span class="sd">        Check if the input object is a numerical value, i.e. a float</span>
<span class="sd">        :param j: input object to check</span>
<span class="sd">        :return: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">column_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">_isNumeric</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">column_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;numeric&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">column_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># removes first row (header)</span>

    <span class="n">file_extensions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;.dat&quot;</span><span class="p">,</span> <span class="s2">&quot;.prn&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;dat&quot;</span><span class="p">,</span> <span class="s2">&quot;prn&quot;</span><span class="p">}</span>
    <span class="n">response_time_series_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">column_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="s2">&quot;string&quot;</span><span class="p">:</span>
            <span class="n">file_ext</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">file_ext</span> <span class="ow">in</span> <span class="n">file_extensions</span><span class="p">:</span>
                <span class="n">response_time_series_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_time_series_names</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response_time_series_names</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="s2">&quot;400 could not detect timeseries names. There could be hidden characters in your csv&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_remote_video"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_remote_video">[docs]</a><span class="k">def</span> <span class="nf">get_remote_video</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">vsid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a hostname and vsid returns the video given</span>
<span class="sd">    by the vsid</span>
<span class="sd">    :param hostname: connection host name</span>
<span class="sd">    :param vsid: video uuid</span>
<span class="sd">    :return: video</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">get_sid</span><span class="p">(</span><span class="n">hostname</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">get_video</span><span class="p">(</span><span class="n">vsid</span><span class="p">)</span></div>


<div class="viewcode-block" id="post_events"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.post_events">[docs]</a><span class="k">def</span> <span class="nf">post_events</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="c1"># We don&#39;t actually have to do anything here, since the request is already logged.</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;204 Event logged.&quot;</span></div>


<div class="viewcode-block" id="get_configuration_markings"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_markings">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_markings</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">marking</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">marking</span> <span class="ow">in</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">markings</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span>
            <span class="n">key</span> <span class="ow">in</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;allowed-markings&quot;</span><span class="p">]]</span></div>


<div class="viewcode-block" id="get_configuration_parsers"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_parsers">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_parsers</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">parser</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">],</span> <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">parser</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">parser</span> <span class="ow">in</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">parsers</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span></div>


<div class="viewcode-block" id="get_configuration_remote_hosts"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_remote_hosts">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_remote_hosts</span><span class="p">():</span>
    <span class="n">remote_hosts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">remote</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;remote-hosts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">remote</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">remote_hosts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">:</span> <span class="n">agent</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">remote_hosts</span></div>


<div class="viewcode-block" id="get_configuration_support_email"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_support_email">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_support_email</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">][</span><span class="s2">&quot;support-email&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_configuration_injected_code"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_injected_code">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_injected_code</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;injected-code&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_configuration_ga_tracking_id"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_ga_tracking_id">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_ga_tracking_id</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;slycat-web-server&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ga-tracking-id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_configuration_version"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_version">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_version</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">get_configuration_version</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">get_configuration_version</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="n">get_configuration_version</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">get_configuration_version</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> \
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;git&quot;</span><span class="p">,</span> <span class="s2">&quot;rev-parse&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">slycat</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="s2">&quot;commit&quot;</span><span class="p">:</span> <span class="n">get_configuration_version</span><span class="o">.</span><span class="n">commit</span><span class="p">}</span></div>


<span class="n">get_configuration_version</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">get_configuration_version</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">get_configuration_version</span><span class="o">.</span><span class="n">commit</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_configuration_wizards"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.get_configuration_wizards">[docs]</a><span class="nd">@cherrypy</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">json_out</span><span class="p">(</span><span class="n">on</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_configuration_wizards</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">([(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">wizard</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">wizard</span> <span class="ow">in</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">slycat</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">wizards</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span></div>


<div class="viewcode-block" id="tests_request"><a class="viewcode-back" href="../../../../slycat.web.server.handlers.html#slycat.web.server.handlers.tests_request">[docs]</a><span class="k">def</span> <span class="nf">tests_request</span><span class="p">(</span><span class="o">*</span><span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Request: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">request_line</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  Remote IP: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  Remote Port: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  Remote Hostname: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  Scheme: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">scheme</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cherrypy</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">cherrypy</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;  Header: </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="n">cherrypy</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">200</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013, Sandia Corporation. Under the terms of Contract
DE-AC04-94AL85000 with Sandia Corporation, the U.S. Government retains certain
rights in this software

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>